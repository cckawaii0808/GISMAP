<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流浪公園圖台</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: 80vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .map-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .filter-section {
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(145deg, #f0f4f8, #e2e8f0);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }

        .filter-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #4a5568;
            transition: color 0.2s;
        }

        .filter-group label:hover {
            color: #2d3748;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .range-slider {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 5px;
        }

        .legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e2e8f0;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .search-suggestion:hover {
            background-color: #f8f9fa;
        }

        .search-suggestion:last-child {
            border-bottom: none;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .leaflet-popup-content {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .popup-content h4 {
            color: #2d3748;
            margin-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .popup-content p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 8px 0;
        }

        .star {
            color: #ffd700;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: 2;
                max-height: 400px;
            }
            
            .map-container {
                order: 1;
                height: 50vh;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }

        .btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .facility-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
        }

        /* 收入區域叢集樣式 */
        .income-cluster {
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid #333;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 1;
            color: #333;
        }

        .income-cluster.high-income {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .income-cluster.medium-high-income {
            border-color: #FF9800;
            color: #FF9800;
        }

        .income-cluster.medium-income {
            border-color: #2196F3;
            color: #2196F3;
        }

        .income-cluster.low-medium-income {
            border-color: #9C27B0;
            color: #9C27B0;
        }

        .search-container {
            position: relative;
        }

        .ranking-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .ranking-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .ranking-item:hover {
            background-color: #f8f9fa;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .ranking-score {
            float: right;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .score-badge {
            display: inline-block;
            background: rgba(33, 150, 243, 0.1);
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
            font-weight: bold;
        }

        .park-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .park-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .park-item:hover {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            transform: translateX(2px);
        }

        .park-item:last-child {
            border-bottom: none;
        }

        .park-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .park-score {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .park-info {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        .park-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 6px;
            font-size: 0.75rem;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            font-weight: bold;
            color: #495057;
        }

        .stat-value {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-tree"></i> 流浪公園圖台</h1>
            <p>尋找適合夜宿的安全公園，提供完整的設施與周邊資訊</p>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="🔍 搜尋公園名稱..." id="searchBox">
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>
                
                <div class="filter-section">
                    <h3><i class="fas fa-star"></i> 夜宿適宜度</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="highSuitability" checked> ⭐ 高適宜度 (8-10分)</label>
                        <label><input type="checkbox" id="mediumSuitability" checked> 🔶 中適宜度 (5-7分)</label>
                        <label><input type="checkbox" id="lowSuitability"> ❌ 低適宜度 (1-4分)</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-home"></i> 必要設施</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="shelter"> 🏠 遮蔽設施</label>
                        <label><input type="checkbox" id="bench"> 🪑 座椅/長椅</label>
                        <label><input type="checkbox" id="water"> 💧 飲水設施</label>
                        <label><input type="checkbox" id="toilet"> 🚻 公共廁所</label>
                        <label><input type="checkbox" id="lighting"> 💡 夜間照明</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-subway"></i> 交通便利性</h3>
                    <div class="filter-group">
                        <label>捷運站距離 (公尺)</label>
                        <input type="range" class="range-slider" id="mrtDistance" min="0" max="2000" value="1000" step="100">
                        <div class="range-value" id="mrtValue">1000公尺內</div>
                    </div>
                    <div class="filter-group">
                        <label>公車站距離 (公尺)</label>
                        <input type="range" class="range-slider" id="busDistance" min="0" max="1000" value="500" step="50">
                        <div class="range-value" id="busValue">500公尺內</div>
                    </div>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showMRT" checked> 顯示捷運站</label>
                        <label><input type="checkbox" id="showBus" checked> 顯示公車站</label>
                        <label><input type="checkbox" id="showBike"> 顯示YouBike</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-dollar-sign"></i> 收入區域篩選</h3>
                    <div class="filter-group">
                        <label>區域平均收入 (萬元/月)</label>
                        <input type="range" class="range-slider" id="incomeRange" min="25" max="80" value="60" step="5">
                        <div class="range-value" id="incomeValue">60萬以下區域</div>
                    </div>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showIncomeLayer" checked> 顯示收入分析圖層</label>
                        <label><input type="checkbox" id="onlySelectedIncome"> 僅顯示選定收入區域</label>
                        <label><input type="checkbox" id="showIncomeCluster" checked> 顯示收入區域叢集</label>
                    </div>
                    <div class="filter-group">
                        <label>收入區域圓圈半徑 (公尺) - 影響範圍</label>
                        <input type="range" class="range-slider" id="incomeCircleRadius" min="300" max="1500" value="700" step="50">
                        <div class="range-value" id="incomeCircleRadiusValue">700公尺</div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-store"></i> 生活機能</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="convenience" checked> 🏪 便利商店</label>
                        <label><input type="checkbox" id="pharmacy"> 💊 藥局</label>
                        <label><input type="checkbox" id="restaurant"> 🍔 餐廳</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-circle-dot"></i> 以公園為中心的功能圓圈</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showWalkingRange" checked> 🚶 步行舒適範圍</label>
                        <label><input type="checkbox" id="showTransportRange" checked> 🚌 交通可及範圍</label>
                        <label><input type="checkbox" id="showLifeRange"> 🏪 生活機能範圍</label>
                        <label><input type="checkbox" id="showSafetyRange"> 🛡️ 安全影響範圍</label>
                        <label><input type="checkbox" id="showParkLabels" checked> 🏷️ 顯示公園名稱</label>
                    </div>
                    <div class="filter-group">
                        <label>步行舒適範圍 (公尺) - 適合日常活動</label>
                        <input type="range" class="range-slider" id="walkingRadius" min="100" max="500" value="200" step="25">
                        <div class="range-value" id="walkingRadiusValue">200公尺</div>
                    </div>
                    <div class="filter-group">
                        <label>交通可及範圍 (公尺) - 能到達交通站點</label>
                        <input type="range" class="range-slider" id="transportRadius" min="300" max="1200" value="600" step="50">
                        <div class="range-value" id="transportRadiusValue">600公尺</div>
                    </div>
                    <div class="filter-group">
                        <label>生活機能範圍 (公尺) - 便利商店、餐廳等</label>
                        <input type="range" class="range-slider" id="lifeRadius" min="400" max="1000" value="800" step="50">
                        <div class="range-value" id="lifeRadiusValue">800公尺</div>
                    </div>
                    <div class="filter-group">
                        <label>安全影響範圍 (公尺) - 周邊環境安全度</label>
                        <input type="range" class="range-slider" id="safetyRadius" min="200" max="800" value="400" step="50">
                        <div class="range-value" id="safetyRadiusValue">400公尺</div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-star"></i> 綜合評分設定</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="enableScoring" checked> 📊 啟用綜合評分</label>
                        <label><input type="checkbox" id="showScoreRanking"> 🏆 顯示評分排名</label>
                    </div>
                    <div class="filter-group">
                        <label>交通便利性權重 (%)</label>
                        <input type="range" class="range-slider" id="transportWeight" min="0" max="100" value="35" step="5">
                        <div class="range-value" id="transportWeightValue">35%</div>
                    </div>
                    <div class="filter-group">
                        <label>設施完善度權重 (%)</label>
                        <input type="range" class="range-slider" id="facilityWeight" min="0" max="100" value="25" step="5">
                        <div class="range-value" id="facilityWeightValue">25%</div>
                    </div>
                    <div class="filter-group">
                        <label>夜宿適宜度權重 (%)</label>
                        <input type="range" class="range-slider" id="suitabilityWeight" min="0" max="100" value="30" step="5">
                        <div class="range-value" id="suitabilityWeightValue">30%</div>
                    </div>
                    <div class="filter-group">
                        <label>安全評分權重 (%)</label>
                        <input type="range" class="range-slider" id="safetyWeight" min="0" max="100" value="10" step="5">
                        <div class="range-value" id="safetyWeightValue">10%</div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-list"></i> 公園詳細列表</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showParkList" checked> 📋 顯示公園列表</label>
                        <label><input type="checkbox" id="showOnlyVisible"> 👁️ 僅顯示可見公園</label>
                    </div>
                </div>

                <div class="filter-section" id="parkListSection">
                    <h3><i class="fas fa-map-marker-alt"></i> 公園資訊</h3>
                    <div id="parkDetailList" class="park-list">
                        <!-- 公園詳細列表將在這裡顯示 -->
                    </div>
                </div>

                <div class="legend">
                    <h4>圖例說明</h4>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4CAF50;"></span>
                        高適宜度公園 (8-10分)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #FF9800;"></span>
                        中適宜度公園 (5-7分)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #F44336;"></span>
                        低適宜度公園 (1-4分)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #2196F3;"></span>
                        捷運站 / BRT站
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #FF5722;"></span>
                        公車站
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4CAF50;"></span>
                        高收入區 (60萬+)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #FF9800;"></span>
                        中高收入區 (45-60萬)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #2196F3;"></span>
                        中等收入區 (35-45萬)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #9C27B0;"></span>
                        中低收入區 (25-35萬)
                    </div>
                </div>

                <button class="btn" onclick="resetFilters()">
                    <i class="fas fa-refresh"></i> 重置篩選
                </button>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="info-panel" id="infoPanel">
                    <h4 id="infoPanelTitle">資訊面板</h4>
                    <div id="infoPanelContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // 初始化地圖 (以台中市中心為中心)
        let map = L.map('map').setView([24.1477, 120.6736], 12);

        // 添加底圖 - 使用更簡潔的CartoDB地圖
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // 圖層群組
        let parkLayers = L.layerGroup().addTo(map);
        let walkingRangeLayers = L.layerGroup().addTo(map);
        let transportRangeLayers = L.layerGroup().addTo(map);
        let lifeRangeLayers = L.layerGroup().addTo(map);
        let safetyRangeLayers = L.layerGroup().addTo(map);
        let parkLabelLayers = L.layerGroup().addTo(map);
        let transportLayers = L.layerGroup().addTo(map);
        let facilityLayers = L.layerGroup().addTo(map);
        let incomeCircleLayers = L.layerGroup().addTo(map);
        let incomeClusterGroup = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                const markers = cluster.getAllChildMarkers();
                const avgIncome = markers.reduce((sum, marker) => sum + marker.options.income, 0) / markers.length;
                
                let className = 'income-cluster';
                if (avgIncome >= 60) className += ' high-income';
                else if (avgIncome >= 45) className += ' medium-high-income';
                else if (avgIncome >= 35) className += ' medium-income';
                else className += ' low-medium-income';
                
                return L.divIcon({
                    html: '<div class="' + className + '">' + markers.length + '</div>',
                    className: 'marker-cluster',
                    iconSize: L.point(40, 40)
                });
            },
            maxClusterRadius: 80
        }).addTo(map);

        const incomeAreas = [
            // 高收入區域 (60萬以上)
            {name: "七期重劃區", bounds: [[24.1589, 120.6312], [24.1723, 120.6445]], income: 75, level: "高收入區"},
            {name: "西屯惠來里", bounds: [[24.1634, 120.6223], [24.1756, 120.6356]], income: 72, level: "高收入區"},
            {name: "南屯豐富里", bounds: [[24.1423, 120.6189], [24.1512, 120.6312]], income: 68, level: "高收入區"},
            {name: "北屯廍子重劃區", bounds: [[24.1789, 120.7012], [24.1878, 120.7145]], income: 65, level: "高收入區"},
            {name: "西區美術園道", bounds: [[24.1501, 120.6567], [24.1578, 120.6689]], income: 63, level: "高收入區"},
            
            // 中高收入區域 (45-60萬)
            {name: "北屯松竹區", bounds: [[24.1789, 120.6823], [24.1889, 120.6923]], income: 58, level: "中高收入區"},
            {name: "西屯朝馬區", bounds: [[24.1689, 120.6123], [24.1756, 120.6234]], income: 55, level: "中高收入區"},
            {name: "南區興大區", bounds: [[24.1201, 120.6789], [24.1289, 120.6889]], income: 52, level: "中高收入區"},
            {name: "北區一中商圈", bounds: [[24.1534, 120.6712], [24.1634, 120.6823]], income: 50, level: "中高收入區"},
            {name: "文心森林公園周邊", bounds: [[24.1356, 120.6423], [24.1423, 120.6489]], income: 48, level: "中高收入區"},
            
            // 中等收入區域 (35-45萬)
            {name: "東區樂成區", bounds: [[24.1334, 120.6889], [24.1423, 120.6989]], income: 42, level: "中等收入區"},
            {name: "中區台中車站", bounds: [[24.1389, 120.6789], [24.1478, 120.6889]], income: 40, level: "中等收入區"},
            {name: "太平新光區", bounds: [[24.1123, 120.7123], [24.1234, 120.7234]], income: 38, level: "中等收入區"},
            {name: "大里草湖區", bounds: [[24.0889, 120.6789], [24.1023, 120.6889]], income: 36, level: "中等收入區"},
            {name: "豐原市中心", bounds: [[24.2456, 120.7156], [24.2567, 120.7267]], income: 35, level: "中等收入區"},
            
            // 中低收入區域 (25-35萬)
            {name: "烏日區", bounds: [[24.1023, 120.6123], [24.1156, 120.6267]], income: 32, level: "中低收入區"},
            {name: "霧峰區", bounds: [[24.0589, 120.6889], [24.0723, 120.7023]], income: 30, level: "中低收入區"},
            {name: "潭子頭家區", bounds: [[24.2089, 120.6889], [24.2189, 120.6989]], income: 28, level: "中低收入區"},
            {name: "大雅區", bounds: [[24.2223, 120.6456], [24.2334, 120.6567]], income: 27, level: "中低收入區"},
            {name: "清水區", bounds: [[24.2589, 120.5623], [24.2723, 120.5756]], income: 25, level: "中低收入區"}
        ];

        // 台中公車站資料
        const busData = [
            // 主要公車站
            {name: "台中車站", lat: 24.1369, lng: 120.6863, routes: ["1", "6", "9", "14", "15", "18", "21", "35", "71", "100", "101", "102", "103", "105", "106", "107", "108"]},
            {name: "中友百貨", lat: 24.1534, lng: 120.6823, routes: ["6", "9", "33", "35", "41", "61", "71", "131", "132", "142", "146"]},
            {name: "一中商圈", lat: 24.1556, lng: 120.6789, routes: ["6", "9", "33", "35", "41", "61", "71", "131", "132", "142"]},
            {name: "科博館", lat: 24.1523, lng: 120.6723, routes: ["11", "23", "35", "37", "71", "75", "83", "102", "103", "105"]},
            {name: "廣三SOGO", lat: 24.1489, lng: 120.6689, routes: ["11", "23", "35", "37", "71", "75", "83", "102", "103"]},
            {name: "文心森林公園", lat: 24.1389, lng: 120.6456, routes: ["23", "53", "73", "77", "290", "356", "359"]},
            {name: "豐樂公園", lat: 24.1278, lng: 120.6534, routes: ["53", "73", "77", "290", "356", "359"]},
            {name: "秋紅谷", lat: 24.1634, lng: 120.6334, routes: ["25", "45", "161", "323", "324", "325", "326"]},
            {name: "朝馬", lat: 24.1723, lng: 120.6234, routes: ["25", "45", "161", "323", "324", "325", "326"]},
            {name: "新光三越", lat: 24.1656, lng: 120.6389, routes: ["25", "45", "161", "323", "324", "325"]},
            {name: "市政府", lat: 24.1623, lng: 120.6445, routes: ["25", "45", "161", "323", "324", "325"]},
            {name: "豐原車站", lat: 24.2523, lng: 120.7234, routes: ["12", "63", "90", "91", "92", "93", "186", "206", "207", "208", "209", "213", "218", "220", "227", "228", "229", "235", "236", "237", "238", "239"]},
            {name: "大里車站", lat: 24.0998, lng: 120.6789, routes: ["50", "53", "59", "74", "100", "107", "108", "131", "132", "201", "280", "285"]},
            {name: "太平車站", lat: 24.1234, lng: 120.7234, routes: ["15", "41", "74", "163", "280", "285", "286", "287", "288"]},
            {name: "烏日車站", lat: 24.1089, lng: 120.6234, routes: ["26", "69", "99", "102", "105", "617", "655"]},
            {name: "霧峰", lat: 24.0678, lng: 120.6923, routes: ["50", "59", "201", "281", "282", "283", "284"]},
            {name: "潭子車站", lat: 24.2123, lng: 120.7034, routes: ["63", "65", "178", "900", "901", "920", "921", "922"]},
            {name: "大雅", lat: 24.2289, lng: 120.6534, routes: ["65", "128", "133", "154", "700", "701", "704"]},
            {name: "神岡", lat: 24.2456, lng: 120.6712, routes: ["63", "65", "154", "700", "701", "704"]},
            {name: "后里車站", lat: 24.3123, lng: 120.7156, routes: ["155", "214", "215", "616", "811", "813"]},
            {name: "東勢", lat: 24.2634, lng: 120.8234, routes: ["153", "206", "207", "208", "209", "850", "865", "866", "867"]},
            {name: "清水車站", lat: 24.2645, lng: 120.5689, routes: ["111", "115", "123", "128", "166", "167", "168", "169", "170", "171", "172", "173", "174", "175", "176", "177", "178", "179", "180", "181", "182", "183", "184", "185"]},
            {name: "沙鹿車站", lat: 24.2345, lng: 120.5689, routes: ["166", "167", "168", "169", "170", "171", "172", "173", "174"]},
            {name: "梧棲", lat: 24.2890, lng: 120.5234, routes: ["123", "128", "166", "167", "168", "169"]},
            {name: "龍井車站", lat: 24.1923, lng: 120.5456, routes: ["617", "655", "656", "657", "658", "659"]},
            {name: "大甲車站", lat: 24.3456, lng: 120.6234, routes: ["185", "186", "187", "188", "189", "190", "191", "192", "193", "194", "195"]}
        ];

        // 台中市公園資料 (100+個點位)
        const parkData = [
            // 中區
            {name: "台中公園", lat: 24.1441, lng: 120.6813, suitability: 8, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "台中市最具歷史的公園，湖心亭為地標。", income_level: "中收入區", safety_score: 8},
            {name: "中山公園", lat: 24.1401, lng: 120.6789, suitability: 7, facilities: ["bench", "lighting"], description: "市中心小型公園，交通便利。", income_level: "中收入區", safety_score: 7},
            {name: "民權公園", lat: 24.1456, lng: 120.6834, suitability: 6, facilities: ["bench", "water"], description: "社區型公園，設施簡單。", income_level: "中收入區", safety_score: 6},
            
            // 東區
            {name: "樂成公園", lat: 24.1378, lng: 120.6912, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "設施完善的大型公園，適合夜宿。", income_level: "中收入區", safety_score: 9},
            {name: "旱溪東路公園", lat: 24.1345, lng: 120.6987, suitability: 7, facilities: ["shelter", "bench", "lighting"], description: "河岸公園，環境清幽。", income_level: "中收入區", safety_score: 7},
            {name: "東門公園", lat: 24.1412, lng: 120.6923, suitability: 6, facilities: ["bench", "water"], description: "小型鄰里公園。", income_level: "中收入區", safety_score: 6},
            {name: "復興公園", lat: 24.1389, lng: 120.6945, suitability: 8, facilities: ["shelter", "bench", "toilet", "lighting"], description: "社區中心型公園，安全性佳。", income_level: "中收入區", safety_score: 8},
            {name: "進德公園", lat: 24.1356, lng: 120.6967, suitability: 5, facilities: ["bench"], description: "較小的社區公園。", income_level: "中收入區", safety_score: 5},
            
            // 西區
            {name: "草悟道", lat: 24.1519, lng: 120.6644, suitability: 7, facilities: ["lighting", "bench"], description: "知名綠園道，但夜間較多人群。", income_level: "高收入區", safety_score: 7},
            {name: "美術園道", lat: 24.1534, lng: 120.6623, suitability: 6, facilities: ["bench", "lighting"], description: "藝文區域，環境優美。", income_level: "高收入區", safety_score: 6},
            {name: "忠明公園", lat: 24.1487, lng: 120.6578, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "設施良好的住宅區公園。", income_level: "高收入區", safety_score: 8},
            {name: "向上公園", lat: 24.1423, lng: 120.6545, suitability: 7, facilities: ["bench", "water", "lighting"], description: "社區公園，環境整潔。", income_level: "中收入區", safety_score: 7},
            {name: "英才公園", lat: 24.1456, lng: 120.6612, suitability: 6, facilities: ["bench", "lighting"], description: "校園附近公園。", income_level: "中收入區", safety_score: 6},
            
            // 南區
            {name: "興大康橋", lat: 24.1245, lng: 120.6823, suitability: 8, facilities: ["shelter", "bench", "water", "lighting"], description: "大學附近，環境優美。", income_level: "中收入區", safety_score: 8},
            {name: "中興大學校園", lat: 24.1234, lng: 120.6798, suitability: 7, facilities: ["bench", "water", "toilet"], description: "校園綠地，夜間較安靜。", income_level: "中收入區", safety_score: 7},
            {name: "文心森林公園", lat: 24.1389, lng: 120.6456, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "大型森林公園，設施完善。", income_level: "中收入區", safety_score: 9},
            {name: "豐樂雕塑公園", lat: 24.1278, lng: 120.6534, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "藝術主題公園，環境佳。", income_level: "中收入區", safety_score: 8},
            {name: "南屯公園", lat: 24.1234, lng: 120.6456, suitability: 6, facilities: ["bench", "lighting"], description: "社區型公園。", income_level: "中收入區", safety_score: 6},
            
            // 北區
            {name: "北屯兒童公園", lat: 24.1612, lng: 120.6823, suitability: 7, facilities: ["shelter", "bench", "water"], description: "親子公園，設施較新。", income_level: "中收入區", safety_score: 7},
            {name: "新民公園", lat: 24.1578, lng: 120.6756, suitability: 6, facilities: ["bench", "lighting"], description: "住宅區小公園。", income_level: "中收入區", safety_score: 6},
            {name: "健行公園", lat: 24.1623, lng: 120.6789, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "運動休閒公園。", income_level: "中收入區", safety_score: 8},
            {name: "中清公園", lat: 24.1645, lng: 120.6712, suitability: 5, facilities: ["bench"], description: "較小型的社區公園。", income_level: "中收入區", safety_score: 5},
            
            // 北屯區
            {name: "廍子公園", lat: 24.1812, lng: 120.7123, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "新興區域大型公園，設施完善。", income_level: "高收入區", safety_score: 9},
            {name: "四維公園", lat: 24.1734, lng: 120.6998, suitability: 7, facilities: ["bench", "water", "lighting"], description: "住宅區公園，環境清幽。", income_level: "中收入區", safety_score: 7},
            {name: "北屯公園", lat: 24.1698, lng: 120.6923, suitability: 8, facilities: ["shelter", "bench", "toilet", "lighting"], description: "區域性公園，設施良好。", income_level: "中收入區", safety_score: 8},
            {name: "松竹公園", lat: 24.1823, lng: 120.6876, suitability: 6, facilities: ["bench", "lighting"], description: "捷運站附近小公園。", income_level: "中收入區", safety_score: 6},
            {name: "軍功公園", lat: 24.1856, lng: 120.7034, suitability: 7, facilities: ["shelter", "bench", "water"], description: "山區邊緣公園，空氣佳。", income_level: "中收入區", safety_score: 7},
            
            // 西屯區
            {name: "秋紅谷生態公園", lat: 24.1634, lng: 120.6334, suitability: 8, facilities: ["shelter", "bench", "lighting"], description: "知名生態公園，但夜間人流多。", income_level: "高收入區", safety_score: 7},
            {name: "朝馬公園", lat: 24.1723, lng: 120.6234, suitability: 6, facilities: ["bench", "water"], description: "交通要道旁公園。", income_level: "高收入區", safety_score: 6},
            {name: "福安公園", lat: 24.1689, lng: 120.6145, suitability: 7, facilities: ["shelter", "bench", "toilet"], description: "住宅區公園，設施中等。", income_level: "高收入區", safety_score: 7},
            {name: "何厝公園", lat: 24.1756, lng: 120.6278, suitability: 5, facilities: ["bench"], description: "小型社區公園。", income_level: "中收入區", safety_score: 5},
            {name: "西屯公園", lat: 24.1612, lng: 120.6156, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "區域中心公園，設施完善。", income_level: "中收入區", safety_score: 8},
            
            // 南屯區
            {name: "豐富公園", lat: 24.1456, lng: 120.6312, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "高級住宅區公園，設施優良。", income_level: "高收入區", safety_score: 9},
            {name: "南屯親子公園", lat: 24.1378, lng: 120.6234, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "親子友善公園，安全性高。", income_level: "高收入區", safety_score: 8},
            {name: "春安公園", lat: 24.1423, lng: 120.6189, suitability: 7, facilities: ["bench", "water", "lighting"], description: "社區公園，環境良好。", income_level: "中收入區", safety_score: 7},
            {name: "向心公園", lat: 24.1512, lng: 120.6267, suitability: 6, facilities: ["bench", "lighting"], description: "小型鄰里公園。", income_level: "中收入區", safety_score: 6},
            
            // 太平區
            {name: "太平買菸場", lat: 24.1234, lng: 120.7234, suitability: 7, facilities: ["shelter", "bench", "water"], description: "文創園區綠地，環境特殊。", income_level: "中收入區", safety_score: 7},
            {name: "頭汴坑蝙蝠洞公園", lat: 24.1123, lng: 120.7345, suitability: 5, facilities: ["bench"], description: "山區公園，較偏僻。", income_level: "低收入區", safety_score: 4},
            {name: "太平公園", lat: 24.1189, lng: 120.7198, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "區域主要公園，設施完善。", income_level: "中收入區", safety_score: 8},
            {name: "新光公園", lat: 24.1145, lng: 120.7156, suitability: 6, facilities: ["bench", "lighting"], description: "住宅區公園。", income_level: "中收入區", safety_score: 6},
            
            // 大里區
            {name: "大里杙公園", lat: 24.0998, lng: 120.6789, suitability: 8, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "大里主要公園，設施良好。", income_level: "中收入區", safety_score: 8},
            {name: "草湖公園", lat: 24.0923, lng: 120.6834, suitability: 6, facilities: ["bench", "water"], description: "社區型公園。", income_level: "中收入區", safety_score: 6},
            {name: "塗城公園", lat: 24.1034, lng: 120.6712, suitability: 7, facilities: ["shelter", "bench", "lighting"], description: "住宅區公園，環境整潔。", income_level: "中收入區", safety_score: 7},
            {name: "健民公園", lat: 24.0989, lng: 120.6756, suitability: 5, facilities: ["bench"], description: "小型公園，設施簡單。", income_level: "中收入區", safety_score: 5},
            
            // 烏日區
            {name: "烏日啤酒觀光工廠", lat: 24.1089, lng: 120.6234, suitability: 6, facilities: ["shelter", "bench"], description: "觀光工廠綠地，白天較熱鬧。", income_level: "中收入區", safety_score: 6},
            {name: "烏日公園", lat: 24.1056, lng: 120.6178, suitability: 7, facilities: ["bench", "water", "toilet"], description: "區域公園，基本設施齊全。", income_level: "中收入區", safety_score: 7},
            {name: "溪尾公園", lat: 24.1123, lng: 120.6145, suitability: 5, facilities: ["bench"], description: "小型社區公園。", income_level: "中收入區", safety_score: 5},
            
            // 霧峰區
            {name: "霧峰林家花園", lat: 24.0634, lng: 120.6998, suitability: 6, facilities: ["shelter", "bench"], description: "古蹟園區，環境優美但有管制。", income_level: "中收入區", safety_score: 6},
            {name: "霧峰公園", lat: 24.0678, lng: 120.6923, suitability: 7, facilities: ["bench", "water", "lighting"], description: "區域中心公園。", income_level: "中收入區", safety_score: 7},
            {name: "光復公園", lat: 24.0712, lng: 120.6878, suitability: 5, facilities: ["bench"], description: "住宅區小公園。", income_level: "中收入區", safety_score: 5},
            
            // 豐原區
            {name: "豐原公園", lat: 24.2523, lng: 120.7234, suitability: 8, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "豐原主要公園，設施完善。", income_level: "中收入區", safety_score: 8},
            {name: "廟東夜市旁公園", lat: 24.2489, lng: 120.7198, suitability: 4, facilities: ["bench"], description: "夜市旁小公園，夜間較吵雜。", income_level: "中收入區", safety_score: 4},
            {name: "南陽公園", lat: 24.2556, lng: 120.7156, suitability: 7, facilities: ["shelter", "bench", "water"], description: "住宅區公園，環境清幽。", income_level: "中收入區", safety_score: 7},
            {name: "豐東公園", lat: 24.2534, lng: 120.7289, suitability: 6, facilities: ["bench", "lighting"], description: "社區型公園。", income_level: "中收入區", safety_score: 6},
            
            // 潭子區
            {name: "潭子運動公園", lat: 24.2123, lng: 120.7034, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "大型運動公園，設施完善且安全。", income_level: "中收入區", safety_score: 9},
            {name: "潭子公園", lat: 24.2089, lng: 120.6998, suitability: 7, facilities: ["bench", "water", "lighting"], description: "區域中心公園。", income_level: "中收入區", safety_score: 7},
            {name: "頭家公園", lat: 24.2156, lng: 120.6923, suitability: 6, facilities: ["bench", "lighting"], description: "住宅區公園。", income_level: "中收入區", safety_score: 6}
        ];

        // 台中捷運站資料
        const mrtData = [
            // 綠線 (烏日文心北屯線)
            {name: "北屯總站", lat: 24.1612, lng: 120.6834, line: "綠線"},
            {name: "舊社站", lat: 24.1589, lng: 120.6823, line: "綠線"},
            {name: "松竹站", lat: 24.1534, lng: 120.6812, line: "綠線"},
            {name: "四維國小站", lat: 24.1498, lng: 120.6801, line: "綠線"},
            {name: "崇德文心站", lat: 24.1467, lng: 120.6789, line: "綠線"},
            {name: "中清文心站", lat: 24.1423, lng: 120.6778, line: "綠線"},
            {name: "文華高中站", lat: 24.1389, lng: 120.6767, line: "綠線"},
            {name: "櫻花文心站", lat: 24.1356, lng: 120.6756, line: "綠線"},
            {name: "市政府站", lat: 24.1623, lng: 120.6445, line: "綠線"},
            {name: "水安宮站", lat: 24.1598, lng: 120.6434, line: "綠線"},
            {name: "文心森林公園站", lat: 24.1389, lng: 120.6456, line: "綠線"},
            {name: "南屯站", lat: 24.1312, lng: 120.6423, line: "綠線"},
            {name: "豐樂公園站", lat: 24.1278, lng: 120.6534, line: "綠線"},
            {name: "大慶站", lat: 24.1134, lng: 120.6389, line: "綠線"},
            {name: "九張犁站", lat: 24.1089, lng: 120.6378, line: "綠線"},
            {name: "烏日站", lat: 24.1056, lng: 120.6367, line: "綠線"},
            
            // 藍線 (機場捷運延伸規劃)
            {name: "台中車站", lat: 24.1369, lng: 120.6863, line: "藍線(規劃)"},
            {name: "五權站", lat: 24.1423, lng: 120.6734, line: "藍線(規劃)"},
            {name: "中友百貨站", lat: 24.1534, lng: 120.6823, line: "藍線(規劃)"},
            
            // 捷運快線BRT
            {name: "台中火車站", lat: 24.1369, lng: 120.6863, line: "BRT"},
            {name: "仁友東站", lat: 24.1398, lng: 120.6812, line: "BRT"},
            {name: "彰化銀行站", lat: 24.1445, lng: 120.6789, line: "BRT"},
            {name: "中區公所站", lat: 24.1467, lng: 120.6767, line: "BRT"},
            {name: "第一廣場站", lat: 24.1489, lng: 120.6745, line: "BRT"},
            {name: "科博館站", lat: 24.1523, lng: 120.6723, line: "BRT"},
            {name: "頂何厝站", lat: 24.1556, lng: 120.6701, line: "BRT"},
            {name: "忠明國小站", lat: 24.1578, lng: 120.6678, line: "BRT"},
            {name: "中山醫大站", lat: 24.1612, lng: 120.6656, line: "BRT"},
            {name: "河南路站", lat: 24.1634, lng: 120.6634, line: "BRT"},
            {name: "朝馬站", lat: 24.1667, lng: 120.6612, line: "BRT"}
        ];

        // 台中便利商店資料
        const convenienceData = [
            // 中區
            {name: "7-ELEVEN 台中車站店", lat: 24.1369, lng: 120.6863, type: "7-11"},
            {name: "全家 中華店", lat: 24.1445, lng: 120.6823, type: "family"},
            {name: "萊爾富 中區店", lat: 24.1423, lng: 120.6801, type: "hilife"},
            
            // 東區
            {name: "7-ELEVEN 樂成店", lat: 24.1378, lng: 120.6923, type: "7-11"},
            {name: "全家 東門店", lat: 24.1412, lng: 120.6945, type: "family"},
            {name: "OK便利商店 復興店", lat: 24.1389, lng: 120.6967, type: "ok"},
            {name: "7-ELEVEN 進德店", lat: 24.1356, lng: 120.6989, type: "7-11"},
            
            // 西區
            {name: "7-ELEVEN 草悟道店", lat: 24.1519, lng: 120.6644, type: "7-11"},
            {name: "全家 美術館店", lat: 24.1534, lng: 120.6623, type: "family"},
            {name: "萊爾富 忠明店", lat: 24.1487, lng: 120.6578, type: "hilife"},
            {name: "7-ELEVEN 向上店", lat: 24.1423, lng: 120.6545, type: "7-11"},
            {name: "OK便利商店 英才店", lat: 24.1456, lng: 120.6612, type: "ok"},
            
            // 南區
            {name: "7-ELEVEN 興大店", lat: 24.1245, lng: 120.6823, type: "7-11"},
            {name: "全家 文心店", lat: 24.1389, lng: 120.6456, type: "family"},
            {name: "7-ELEVEN 豐樂店", lat: 24.1278, lng: 120.6534, type: "7-11"},
            {name: "萊爾富 南屯店", lat: 24.1234, lng: 120.6456, type: "hilife"},
            
            // 北區
            {name: "7-ELEVEN 一中店", lat: 24.1578, lng: 120.6756, type: "7-11"},
            {name: "全家 健行店", lat: 24.1623, lng: 120.6789, type: "family"},
            {name: "OK便利商店 中清店", lat: 24.1645, lng: 120.6712, type: "ok"},
            {name: "7-ELEVEN 新民店", lat: 24.1612, lng: 120.6823, type: "7-11"}
        ];

        // 自定義圖標
        const createIcon = (color, icon) => {
            return L.divIcon({
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="fas ${icon}" style="color: white; font-size: 10px;"></i></div>`,
                className: 'custom-marker',
                iconSize: [20, 20]
            });
        };

        // 創建文字標籤
        const createTextLabel = (text, options = {}) => {
            const defaultOptions = {
                color: '#2d3748',
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                fontSize: '12px',
                fontWeight: 'bold',
                padding: '4px 8px',
                borderRadius: '4px',
                border: '1px solid #e2e8f0',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                textAlign: 'center',
                minWidth: '60px',
                ...options
            };

            const styles = Object.entries(defaultOptions)
                .map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`)
                .join('; ');

            return L.divIcon({
                html: `<div style="${styles}">${text}</div>`,
                className: 'park-label',
                iconSize: [null, null],
                iconAnchor: [null, null]
            });
        };

        // 搜尋功能實現
        let searchResults = [];
        let currentSelectedIndex = -1;

        function performSearch(query) {
            if (!query || query.length < 1) {
                document.getElementById('searchSuggestions').style.display = 'none';
                return;
            }

            searchResults = parkData.filter(park => 
                park.name.toLowerCase().includes(query.toLowerCase())
            );

            const suggestionsEl = document.getElementById('searchSuggestions');
            
            if (searchResults.length === 0) {
                suggestionsEl.style.display = 'none';
                return;
            }

            const suggestionsHtml = searchResults.slice(0, 5).map((park, index) => `
                <div class="search-suggestion" data-index="${index}">
                    <strong>${park.name}</strong><br>
                    <small>適宜度: ${park.suitability}/10 | ${park.description}</small>
                </div>
            `).join('');

            suggestionsEl.innerHTML = suggestionsHtml;
            suggestionsEl.style.display = 'block';

            // 為建議項目添加點擊事件
            suggestionsEl.querySelectorAll('.search-suggestion').forEach((item, index) => {
                item.addEventListener('click', () => {
                    selectPark(searchResults[index]);
                });
            });
        }

        function selectPark(park) {
            map.setView([park.lat, park.lng], 16);
            document.getElementById('searchBox').value = park.name;
            document.getElementById('searchSuggestions').style.display = 'none';
            
            // 找到對應的marker並打開popup
            parkLayers.eachLayer(layer => {
                if (layer.getLatLng().lat === park.lat && layer.getLatLng().lng === park.lng) {
                    layer.openPopup();
                }
            });
        }

        // 搜尋框事件監聽
        document.getElementById('searchBox').addEventListener('input', function(e) {
            performSearch(e.target.value);
        });

        // 鍵盤導航
        document.getElementById('searchBox').addEventListener('keydown', function(e) {
            const suggestions = document.querySelectorAll('.search-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSelectedIndex = Math.min(currentSelectedIndex + 1, suggestions.length - 1);
                updateSelectedSuggestion(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
                updateSelectedSuggestion(suggestions);
            } else if (e.key === 'Enter' && currentSelectedIndex >= 0) {
                e.preventDefault();
                selectPark(searchResults[currentSelectedIndex]);
            } else if (e.key === 'Escape') {
                document.getElementById('searchSuggestions').style.display = 'none';
                currentSelectedIndex = -1;
            }
        });

        function updateSelectedSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === currentSelectedIndex) {
                    item.style.backgroundColor = '#e3f2fd';
                } else {
                    item.style.backgroundColor = '';
                }
            });
        }

        // 點擊其他地方隱藏建議
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchSuggestions').style.display = 'none';
                currentSelectedIndex = -1;
            }
        });

        // 渲染公園
        function renderParks() {
            parkLayers.clearLayers();
            walkingRangeLayers.clearLayers();
            transportRangeLayers.clearLayers();
            lifeRangeLayers.clearLayers();
            safetyRangeLayers.clearLayers();
            parkLabelLayers.clearLayers();
            
            parkData.forEach(park => {
                let color = '#F44336'; // 低適宜度 - 紅色
                let show = false;
                
                if (park.suitability >= 8) {
                    color = '#4CAF50'; // 高適宜度 - 綠色
                    show = document.getElementById('highSuitability').checked;
                } else if (park.suitability >= 5) {
                    color = '#FF9800'; // 中適宜度 - 橙色
                    show = document.getElementById('mediumSuitability').checked;
                } else {
                    show = document.getElementById('lowSuitability').checked;
                }
                
                if (!show) return;
                
                // 檢查設施篩選
                const facilityFilters = ['shelter', 'bench', 'water', 'toilet', 'lighting'];
                let facilityMatch = true;
                
                facilityFilters.forEach(facility => {
                    if (document.getElementById(facility).checked && !park.facilities.includes(facility)) {
                        facilityMatch = false;
                    }
                });
                
                if (!facilityMatch) return;
                
                // 檢查交通便利性
                if (!filterParksByTransport(park)) return;
                
                const marker = L.marker([park.lat, park.lng], {
                    icon: createIcon(color, 'fa-tree')
                });
                
                // 計算綜合評分
                const compositeScore = calculateCompositeScore(park);
                const transportScore = calculateTransportScore(park);
                const facilityScore = calculateFacilityScore(park);
                
                // 創建彈出視窗內容
                const facilitiesHtml = park.facilities.map(f => {
                    const icons = {
                        shelter: '🏠', bench: '🪑', water: '💧', 
                        toilet: '🚻', lighting: '💡'
                    };
                    const names = {
                        shelter: '遮蔽設施', bench: '座椅', water: '飲水台',
                        toilet: '廁所', lighting: '照明'
                    };
                    return `${icons[f]} ${names[f]}`;
                }).join('<br>');
                
                // 計算最近的捷運站和公車站
                let nearestMRT = null;
                let nearestBus = null;
                let minMRTDistance = Infinity;
                let minBusDistance = Infinity;
                
                mrtData.forEach(station => {
                    const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                    if (distance < minMRTDistance) {
                        minMRTDistance = distance;
                        nearestMRT = station;
                    }
                });
                
                busData.forEach(busStop => {
                    const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                    if (distance < minBusDistance) {
                        minBusDistance = distance;
                        nearestBus = busStop;
                    }
                });
                
                const popupContent = `
                    <div class="popup-content">
                        <h4>${park.name} ${document.getElementById('enableScoring').checked ? `<span class="score-badge">${compositeScore}</span>` : ''}</h4>
                        <div class="rating">
                            適宜度: ${'⭐'.repeat(Math.floor(park.suitability / 2))} (${park.suitability}/10)
                        </div>
                        ${document.getElementById('enableScoring').checked ? `
                        <p><strong>綜合評分:</strong> ${compositeScore}/10</p>
                        <p><strong>各項評分:</strong></p>
                        <p>　　交通: ${transportScore}/10 | 設施: ${facilityScore}/10</p>
                        <p>　　適宜: ${park.suitability}/10 | 安全: ${park.safety_score}/10</p>
                        ` : ''}
                        <p><strong>描述:</strong> ${park.description}</p>
                        <p><strong>設施:</strong><br>${facilitiesHtml}</p>
                        <p><strong>周邊收入:</strong> ${park.income_level}</p>
                        ${nearestMRT ? `<p><strong>最近捷運:</strong> ${nearestMRT.name} (${Math.round(minMRTDistance)}m)</p>` : ''}
                        ${nearestBus ? `<p><strong>最近公車:</strong> ${nearestBus.name} (${Math.round(minBusDistance)}m)</p>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                parkLayers.addLayer(marker);
                
                // 以公園為中心的功能圓圈
                // 1. 步行舒適範圍 (最內圈)
                if (document.getElementById('showWalkingRange').checked) {
                    const walkingRadius = document.getElementById('walkingRadius').value;
                    const walkingCircle = L.circle([park.lat, park.lng], {
                        color: '#4CAF50',
                        fillColor: '#4CAF50',
                        fillOpacity: 0.15,
                        weight: 2,
                        radius: walkingRadius,
                        dashArray: '5, 5'
                    });
                    
                    walkingCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - 步行舒適範圍</h4>
                            <p><strong>範圍:</strong> ${walkingRadius}公尺</p>
                            <p><strong>說明:</strong> 適合日常活動的步行距離</p>
                            <p><strong>涵蓋面積:</strong> 約${Math.round(Math.PI * Math.pow(walkingRadius/1000, 2) * 100) / 100}平方公里</p>
                        </div>
                    `);
                    
                    walkingRangeLayers.addLayer(walkingCircle);
                }
                
                // 2. 交通可及範圍
                if (document.getElementById('showTransportRange').checked) {
                    const transportRadius = document.getElementById('transportRadius').value;
                    const transportCircle = L.circle([park.lat, park.lng], {
                        color: '#2196F3',
                        fillColor: '#2196F3',
                        fillOpacity: 0.08,
                        weight: 2,
                        radius: transportRadius,
                        dashArray: '10, 5'
                    });
                    
                    transportCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - 交通可及範圍</h4>
                            <p><strong>範圍:</strong> ${transportRadius}公尺</p>
                            <p><strong>說明:</strong> 能到達捷運站、公車站的範圍</p>
                            <p><strong>涵蓋面積:</strong> 約${Math.round(Math.PI * Math.pow(transportRadius/1000, 2) * 100) / 100}平方公里</p>
                        </div>
                    `);
                    
                    transportRangeLayers.addLayer(transportCircle);
                }
                
                // 3. 生活機能範圍
                if (document.getElementById('showLifeRange').checked) {
                    const lifeRadius = document.getElementById('lifeRadius').value;
                    const lifeCircle = L.circle([park.lat, park.lng], {
                        color: '#FF9800',
                        fillColor: '#FF9800',
                        fillOpacity: 0.05,
                        weight: 2,
                        radius: lifeRadius,
                        dashArray: '15, 10'
                    });
                    
                    lifeCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - 生活機能範圍</h4>
                            <p><strong>範圍:</strong> ${lifeRadius}公尺</p>
                            <p><strong>說明:</strong> 便利商店、餐廳等生活設施的可及範圍</p>
                            <p><strong>涵蓋面積:</strong> 約${Math.round(Math.PI * Math.pow(lifeRadius/1000, 2) * 100) / 100}平方公里</p>
                        </div>
                    `);
                    
                    lifeRangeLayers.addLayer(lifeCircle);
                }
                
                // 4. 安全影響範圍
                if (document.getElementById('showSafetyRange').checked) {
                    const safetyRadius = document.getElementById('safetyRadius').value;
                    const safetyCircle = L.circle([park.lat, park.lng], {
                        color: '#9C27B0',
                        fillColor: '#9C27B0',
                        fillOpacity: 0.1,
                        weight: 2,
                        radius: safetyRadius,
                        dashArray: '20, 10'
                    });
                    
                    safetyCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - 安全影響範圍</h4>
                            <p><strong>範圍:</strong> ${safetyRadius}公尺</p>
                            <p><strong>說明:</strong> 公園安全性影響的周邊區域</p>
                            <p><strong>安全評分:</strong> ${park.safety_score}/10</p>
                            <p><strong>涵蓋面積:</strong> 約${Math.round(Math.PI * Math.pow(safetyRadius/1000, 2) * 100) / 100}平方公里</p>
                        </div>
                    `);
                    
                    safetyRangeLayers.addLayer(safetyCircle);
                }
                
                // 為公園添加名稱標籤（如果啟用了標籤顯示）
                if (document.getElementById('showParkLabels').checked) {
                    let maxRadius = 0;
                    let labelColor = color;
                    
                    if (document.getElementById('showWalkingRange').checked) {
                        const radius = document.getElementById('walkingRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    if (document.getElementById('showTransportRange').checked) {
                        const radius = document.getElementById('transportRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    if (document.getElementById('showLifeRange').checked) {
                        const radius = document.getElementById('lifeRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    if (document.getElementById('showSafetyRange').checked) {
                        const radius = document.getElementById('safetyRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    
                    // 如果有顯示任何圓圈，就在圓圈中心顯示公園名稱
                    if (maxRadius > 0) {
                    // 計算標籤顯示位置（圓圈中心點）
                    const labelOptions = {
                        color: labelColor,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        fontSize: '11px',
                        fontWeight: 'bold',
                        padding: '3px 6px',
                        borderRadius: '3px',
                        border: `2px solid ${labelColor}`,
                        boxShadow: '0 2px 6px rgba(0,0,0,0.2)',
                        textAlign: 'center',
                        minWidth: 'auto',
                        whiteSpace: 'nowrap'
                    };
                    
                    const labelMarker = L.marker([park.lat, park.lng], {
                        icon: createTextLabel(park.name, labelOptions),
                        zIndexOffset: 1000 // 確保標籤顯示在最上層
                    });
                    
                    // 點擊標籤也能打開彈窗
                    labelMarker.on('click', () => {
                        marker.openPopup();
                    });
                    
                        parkLabelLayers.addLayer(labelMarker);
                    } else {
                        // 如果沒有顯示圓圈，就在公園圖標旁顯示名稱
                        const labelOptions = {
                            color: '#2d3748',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            fontSize: '10px',
                            fontWeight: 'bold',
                            padding: '2px 4px',
                            borderRadius: '2px',
                            border: '1px solid #e2e8f0',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                            textAlign: 'center',
                            minWidth: 'auto',
                            whiteSpace: 'nowrap'
                        };
                        
                        // 在公園圖標右側顯示名稱
                        const labelMarker = L.marker([park.lat, park.lng + 0.001], {
                            icon: createTextLabel(park.name, labelOptions),
                            zIndexOffset: 1000
                        });
                        
                        labelMarker.on('click', () => {
                            marker.openPopup();
                        });
                        
                        parkLabelLayers.addLayer(labelMarker);
                    }
                }
            });
        }

        // 渲染收入區域
        function renderIncomeAreas() {
            incomeCircleLayers.clearLayers();
            incomeClusterGroup.clearLayers();
            
            if (!document.getElementById('showIncomeLayer').checked) return;
            
            const maxIncome = document.getElementById('incomeRange').value;
            const onlySelected = document.getElementById('onlySelectedIncome').checked;
            const showCluster = document.getElementById('showIncomeCluster').checked;
            const circleRadius = document.getElementById('incomeCircleRadius').value;
            
            incomeAreas.forEach(area => {
                if (onlySelected && area.income > maxIncome) return;
                
                let color = '#F44336'; // 低收入 - 紅色
                let opacity = 0.4;
                
                if (area.income >= 60) {
                    color = '#4CAF50'; // 高收入 - 綠色
                } else if (area.income >= 45) {
                    color = '#FF9800'; // 中高收入 - 橙色
                } else if (area.income >= 35) {
                    color = '#2196F3'; // 中等收入 - 藍色
                } else {
                    color = '#9C27B0'; // 中低收入 - 紫色
                }
                
                // 如果超過設定收入，降低透明度
                if (area.income > maxIncome) {
                    opacity = 0.15;
                }
                
                // 計算收入區域中心點
                const centerLat = (area.bounds[0][0] + area.bounds[1][0]) / 2;
                const centerLng = (area.bounds[0][1] + area.bounds[1][1]) / 2;
                
                // 創建圓圈代替多邊形
                const circle = L.circle([centerLat, centerLng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: opacity,
                    weight: 2,
                    radius: circleRadius,
                    dashArray: '8, 12'
                });
                
                circle.bindPopup(`
                    <div class="popup-content">
                        <h4>${area.name} - 收入影響圈</h4>
                        <p><strong>平均月收入:</strong> ${area.income}萬元</p>
                        <p><strong>收入等級:</strong> ${area.level}</p>
                        <p><strong>影響範圍:</strong> ${circleRadius}公尺</p>
                        <p><strong>涵蓋面積:</strong> 約${Math.round(Math.PI * Math.pow(circleRadius/1000, 2) * 100) / 100}平方公里</p>
                        <p><strong>說明:</strong> 此收入水平對周邊環境的影響範圍</p>
                    </div>
                `);
                
                incomeCircleLayers.addLayer(circle);
                
                // 如果啟用叢集，創建收入區域中心點標記
                if (showCluster) {
                    const marker = L.marker([centerLat, centerLng], {
                        icon: createIcon(color, 'fa-dollar-sign'),
                        income: area.income
                    });
                    
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h4>${area.name}</h4>
                            <p><strong>平均月收入:</strong> ${area.income}萬元</p>
                            <p><strong>收入等級:</strong> ${area.level}</p>
                            <p><strong>影響半徑:</strong> ${circleRadius}公尺</p>
                        </div>
                    `);
                    
                    incomeClusterGroup.addLayer(marker);
                }
            });
        }

        // 渲染捷運站
        function renderMRT() {
            if (!document.getElementById('showMRT').checked) return;
            
            mrtData.forEach(station => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: createIcon('#2196F3', 'fa-subway')
                });
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${station.name}</h4>
                        <p><strong>路線:</strong> ${station.line}</p>
                        <p>🚇 捷運站</p>
                    </div>
                `);
                
                transportLayers.addLayer(marker);
            });
        }

        // 渲染公車站
        function renderBusStops() {
            if (!document.getElementById('showBus').checked) return;
            
            busData.forEach(busStop => {
                const marker = L.marker([busStop.lat, busStop.lng], {
                    icon: createIcon('#FF5722', 'fa-bus')
                });
                
                const routesHtml = busStop.routes.slice(0, 10).join(', ') + 
                    (busStop.routes.length > 10 ? '...' : '');
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${busStop.name}</h4>
                        <p><strong>路線:</strong> ${routesHtml}</p>
                        <p>🚌 公車站 (${busStop.routes.length}條路線)</p>
                    </div>
                `);
                
                transportLayers.addLayer(marker);
            });
        }

        // 渲染便利商店
        function renderConvenience() {
            if (!document.getElementById('convenience').checked) return;
            
            convenienceData.forEach(store => {
                const color = store.type === '7-11' ? '#00A651' : '#0066CC';
                const marker = L.marker([store.lat, store.lng], {
                    icon: createIcon(color, 'fa-store')
                });
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${store.name}</h4>
                        <p>🏪 ${store.type === '7-11' ? '7-ELEVEN' : '全家便利商店'}</p>
                        <p>24小時營業</p>
                    </div>
                `);
                
                facilityLayers.addLayer(marker);
            });
        }

        // 篩選符合交通條件的公園
        function filterParksByTransport(park) {
            const mrtRange = document.getElementById('mrtDistance').value;
            const busRange = document.getElementById('busDistance').value;
            
            let nearMRT = false;
            let nearBus = false;
            
            // 檢查捷運站距離
            if (document.getElementById('showMRT').checked) {
                mrtData.forEach(station => {
                    const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                    if (distance <= mrtRange) nearMRT = true;
                });
            } else {
                nearMRT = true; // 如果不顯示捷運站，則不限制
            }
            
            // 檢查公車站距離  
            if (document.getElementById('showBus').checked) {
                busData.forEach(busStop => {
                    const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                    if (distance <= busRange) nearBus = true;
                });
            } else {
                nearBus = true; // 如果不顯示公車站，則不限制
            }
            
            return nearMRT || nearBus;
        }

        // 計算兩點距離 (公尺)
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // 地球半徑 (公尺)
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 計算公園的交通便利性評分 (0-10)
        function calculateTransportScore(park) {
            let score = 0;
            let nearestMRTDistance = Infinity;
            let nearestBusDistance = Infinity;
            let busRouteCount = 0;

            // 計算最近捷運站距離
            mrtData.forEach(station => {
                const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                if (distance < nearestMRTDistance) {
                    nearestMRTDistance = distance;
                }
            });

            // 計算最近公車站距離和路線數量
            busData.forEach(busStop => {
                const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                if (distance < nearestBusDistance) {
                    nearestBusDistance = distance;
                }
                if (distance <= 500) { // 500公尺內的公車站
                    busRouteCount += busStop.routes.length;
                }
            });

            // 捷運距離評分 (0-4分)
            if (nearestMRTDistance <= 300) score += 4;
            else if (nearestMRTDistance <= 500) score += 3;
            else if (nearestMRTDistance <= 800) score += 2;
            else if (nearestMRTDistance <= 1200) score += 1;

            // 公車距離評分 (0-3分)
            if (nearestBusDistance <= 200) score += 3;
            else if (nearestBusDistance <= 400) score += 2;
            else if (nearestBusDistance <= 600) score += 1;

            // 公車路線數量評分 (0-3分)
            if (busRouteCount >= 20) score += 3;
            else if (busRouteCount >= 10) score += 2;
            else if (busRouteCount >= 5) score += 1;

            return Math.min(score, 10);
        }

        // 計算設施完善度評分 (0-10)
        function calculateFacilityScore(park) {
            const facilityWeights = {
                shelter: 2.5,   // 遮蔽設施
                toilet: 2.5,    // 廁所
                water: 2,       // 飲水設施
                lighting: 2,    // 照明
                bench: 1        // 座椅
            };

            let score = 0;
            park.facilities.forEach(facility => {
                if (facilityWeights[facility]) {
                    score += facilityWeights[facility];
                }
            });

            return Math.min(score, 10);
        }

        // 計算綜合評分
        function calculateCompositeScore(park) {
            if (!document.getElementById('enableScoring').checked) return park.suitability;

            const transportWeight = document.getElementById('transportWeight').value / 100;
            const facilityWeight = document.getElementById('facilityWeight').value / 100;
            const suitabilityWeight = document.getElementById('suitabilityWeight').value / 100;
            const safetyWeight = document.getElementById('safetyWeight').value / 100;

            const transportScore = calculateTransportScore(park);
            const facilityScore = calculateFacilityScore(park);
            const suitabilityScore = park.suitability;
            const safetyScore = park.safety_score;

            const compositeScore = (
                transportScore * transportWeight +
                facilityScore * facilityWeight +
                suitabilityScore * suitabilityWeight +
                safetyScore * safetyWeight
            );

            return Math.round(compositeScore * 10) / 10; // 四捨五入到小數點後一位
        }

        // 計算公園周邊的收入區域
        function getParkIncomeInfo(park) {
            let nearbyIncomeAreas = [];
            
            incomeAreas.forEach(area => {
                const centerLat = (area.bounds[0][0] + area.bounds[1][0]) / 2;
                const centerLng = (area.bounds[0][1] + area.bounds[1][1]) / 2;
                const distance = getDistance(park.lat, park.lng, centerLat, centerLng);
                
                if (distance <= 1000) { // 1公里內
                    nearbyIncomeAreas.push({...area, distance});
                }
            });
            
            nearbyIncomeAreas.sort((a, b) => a.distance - b.distance);
            return nearbyIncomeAreas[0] || {name: "未知區域", income: 0, level: "無資料"};
        }

        // 計算公園周邊的交通資訊
        function getParkTransportInfo(park) {
            let nearbyMRT = [];
            let nearbyBus = [];
            
            mrtData.forEach(station => {
                const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                if (distance <= 1000) {
                    nearbyMRT.push({...station, distance});
                }
            });
            
            busData.forEach(busStop => {
                const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                if (distance <= 800) {
                    nearbyBus.push({...busStop, distance});
                }
            });
            
            nearbyMRT.sort((a, b) => a.distance - b.distance);
            nearbyBus.sort((a, b) => a.distance - b.distance);
            
            return {
                mrtCount: nearbyMRT.length,
                busCount: nearbyBus.length,
                nearestMRT: nearbyMRT[0] || null,
                nearestBus: nearbyBus[0] || null,
                totalBusRoutes: nearbyBus.reduce((sum, bus) => sum + bus.routes.length, 0)
            };
        }

        // 更新公園詳細列表
        function updateParkDetailList() {
            if (!document.getElementById('showParkList').checked) {
                document.getElementById('parkListSection').style.display = 'none';
                return;
            }
            
            document.getElementById('parkListSection').style.display = 'block';
            
            // 獲取符合篩選條件的公園
            let filteredParks = parkData.filter(park => {
                // 適宜度篩選
                let suitabilityMatch = false;
                if (park.suitability >= 8 && document.getElementById('highSuitability').checked) suitabilityMatch = true;
                if (park.suitability >= 5 && park.suitability < 8 && document.getElementById('mediumSuitability').checked) suitabilityMatch = true;
                if (park.suitability < 5 && document.getElementById('lowSuitability').checked) suitabilityMatch = true;
                
                if (!suitabilityMatch) return false;
                
                // 設施篩選
                const facilityFilters = ['shelter', 'bench', 'water', 'toilet', 'lighting'];
                let facilityMatch = true;
                facilityFilters.forEach(facility => {
                    if (document.getElementById(facility).checked && !park.facilities.includes(facility)) {
                        facilityMatch = false;
                    }
                });
                
                if (!facilityMatch) return false;
                
                // 交通便利性篩選
                return filterParksByTransport(park);
            });
            
            // 如果只顯示可見公園，進一步篩選
            if (document.getElementById('showOnlyVisible').checked) {
                // 這裡可以加入更複雜的可見性邏輯
            }
            
            // 按綜合評分排序
            filteredParks = filteredParks.map(park => ({
                ...park,
                compositeScore: calculateCompositeScore(park),
                transportScore: calculateTransportScore(park),
                facilityScore: calculateFacilityScore(park),
                incomeInfo: getParkIncomeInfo(park),
                transportInfo: getParkTransportInfo(park)
            })).sort((a, b) => b.compositeScore - a.compositeScore);
            
            // 生成HTML
            const parkListHtml = filteredParks.map(park => `
                <div class="park-item" onclick="selectParkFromList('${park.name}', ${park.lat}, ${park.lng})">
                    <div class="park-name">
                        ${park.name}
                        <span class="park-score">${park.compositeScore}</span>
                    </div>
                    <div class="park-info">
                        ${park.description}
                    </div>
                    <div class="park-stats">
                        <div class="stat-item">
                            <div class="stat-label">收入區域</div>
                            <div class="stat-value">${park.incomeInfo.name}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">收入水平</div>
                            <div class="stat-value">${park.incomeInfo.income}萬</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">捷運站</div>
                            <div class="stat-value">${park.transportInfo.mrtCount}個</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">公車站</div>
                            <div class="stat-value">${park.transportInfo.busCount}個</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">公車路線</div>
                            <div class="stat-value">${park.transportInfo.totalBusRoutes}條</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">設施完善度</div>
                            <div class="stat-value">${park.facilityScore}/10</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('parkDetailList').innerHTML = parkListHtml;
        }

        // 從列表中選擇公園
        function selectParkFromList(parkName, lat, lng) {
            map.setView([lat, lng], 16);
            
            parkLayers.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                    layer.openPopup();
                }
            });
        }

        // 更新評分排名顯示
        function updateScoreRanking() {
            const showRanking = document.getElementById('showScoreRanking').checked;
            const rankingSection = document.getElementById('scoreRankingSection');
            
            if (!showRanking) {
                rankingSection.style.display = 'none';
                return;
            }
            
            rankingSection.style.display = 'block';
            
            // 計算所有公園的評分並排序
            const rankedParks = parkData.map(park => ({
                ...park,
                compositeScore: calculateCompositeScore(park),
                transportScore: calculateTransportScore(park),
                facilityScore: calculateFacilityScore(park)
            })).sort((a, b) => b.compositeScore - a.compositeScore);
            
            // 只顯示前10名
            const top10Parks = rankedParks.slice(0, 10);
            
            const rankingHtml = top10Parks.map((park, index) => `
                <div class="ranking-item" onclick="selectParkFromRanking('${park.name}', ${park.lat}, ${park.lng})">
                    <span class="ranking-number">${index + 1}</span>
                    <strong>${park.name}</strong>
                    <span class="ranking-score">${park.compositeScore}</span>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
                        交通:${park.transportScore} | 設施:${park.facilityScore} | 適宜:${park.suitability} | 安全:${park.safety_score}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('scoreRankingList').innerHTML = rankingHtml;
        }

        // 從排名中選擇公園
        function selectParkFromRanking(parkName, lat, lng) {
            map.setView([lat, lng], 16);
            
            // 找到對應的marker並打開popup
            parkLayers.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                    layer.openPopup();
                }
            });
        }

        // 更新地圖
        function updateMap() {
            // 清除所有圖層
            transportLayers.clearLayers();
            facilityLayers.clearLayers();
            
            // 重新渲染
            renderParks();
            renderMRT();
            renderBusStops();
            renderConvenience();
            renderIncomeAreas();
            
            // 更新公園列表
            updateParkDetailList();
        }

        // 重置篩選
        function resetFilters() {
            document.getElementById('highSuitability').checked = true;
            document.getElementById('mediumSuitability').checked = true;
            document.getElementById('lowSuitability').checked = false;
            
            ['shelter', 'bench', 'water', 'toilet', 'lighting'].forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            document.getElementById('showMRT').checked = true;
            document.getElementById('showBus').checked = true;
            document.getElementById('showBike').checked = false;
            document.getElementById('showIncomeLayer').checked = true;
            document.getElementById('showIncomeCluster').checked = true;
            document.getElementById('onlySelectedIncome').checked = false;
            document.getElementById('convenience').checked = true;
            document.getElementById('pharmacy').checked = false;
            document.getElementById('restaurant').checked = false;
            document.getElementById('showWalkingRange').checked = true;
            document.getElementById('showTransportRange').checked = true;
            document.getElementById('showLifeRange').checked = false;
            document.getElementById('showSafetyRange').checked = false;
            document.getElementById('showParkLabels').checked = true;
            document.getElementById('enableScoring').checked = true;
            document.getElementById('showParkList').checked = true;
            document.getElementById('showOnlyVisible').checked = false;
            
            document.getElementById('mrtDistance').value = 1000;
            document.getElementById('busDistance').value = 500;
            document.getElementById('incomeRange').value = 60;
            document.getElementById('walkingRadius').value = 200;
            document.getElementById('transportRadius').value = 600;
            document.getElementById('lifeRadius').value = 800;
            document.getElementById('safetyRadius').value = 400;
            document.getElementById('incomeCircleRadius').value = 700;
            document.getElementById('transportWeight').value = 35;
            document.getElementById('facilityWeight').value = 25;
            document.getElementById('suitabilityWeight').value = 30;
            document.getElementById('safetyWeight').value = 10;
            
            document.getElementById('mrtValue').textContent = '1000公尺內';
            document.getElementById('busValue').textContent = '500公尺內';
            document.getElementById('incomeValue').textContent = '60萬以下區域';
            document.getElementById('walkingRadiusValue').textContent = '200公尺';
            document.getElementById('transportRadiusValue').textContent = '600公尺';
            document.getElementById('lifeRadiusValue').textContent = '800公尺';
            document.getElementById('safetyRadiusValue').textContent = '400公尺';
            document.getElementById('incomeCircleRadiusValue').textContent = '700公尺';
            document.getElementById('transportWeightValue').textContent = '35%';
            document.getElementById('facilityWeightValue').textContent = '25%';
            document.getElementById('suitabilityWeightValue').textContent = '30%';
            document.getElementById('safetyWeightValue').textContent = '10%';
            
            updateMap();
        }

        // 距離滑桿更新
        document.getElementById('mrtDistance').addEventListener('input', function(e) {
            document.getElementById('mrtValue').textContent = e.target.value + '公尺內';
            updateMap();
        });

        document.getElementById('busDistance').addEventListener('input', function(e) {
            document.getElementById('busValue').textContent = e.target.value + '公尺內';
            updateMap();
        });

        document.getElementById('incomeRange').addEventListener('input', function(e) {
            document.getElementById('incomeValue').textContent = e.target.value + '萬以下區域';
            updateMap();
        });

        // 功能圓圈半徑滑桿事件監聽器
        document.getElementById('walkingRadius').addEventListener('input', function(e) {
            document.getElementById('walkingRadiusValue').textContent = e.target.value + '公尺';
            updateMap();
        });

        document.getElementById('transportRadius').addEventListener('input', function(e) {
            document.getElementById('transportRadiusValue').textContent = e.target.value + '公尺';
            updateMap();
        });

        document.getElementById('lifeRadius').addEventListener('input', function(e) {
            document.getElementById('lifeRadiusValue').textContent = e.target.value + '公尺';
            updateMap();
        });

        document.getElementById('safetyRadius').addEventListener('input', function(e) {
            document.getElementById('safetyRadiusValue').textContent = e.target.value + '公尺';
            updateMap();
        });

        // 收入區域圓圈半徑滑桿事件監聽器
        document.getElementById('incomeCircleRadius').addEventListener('input', function(e) {
            document.getElementById('incomeCircleRadiusValue').textContent = e.target.value + '公尺';
            updateMap();
        });

        // 評分權重滑桿事件監聽器
        document.getElementById('transportWeight').addEventListener('input', function(e) {
            document.getElementById('transportWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        document.getElementById('facilityWeight').addEventListener('input', function(e) {
            document.getElementById('facilityWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        document.getElementById('suitabilityWeight').addEventListener('input', function(e) {
            document.getElementById('suitabilityWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        document.getElementById('safetyWeight').addEventListener('input', function(e) {
            document.getElementById('safetyWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        // 公園列表顯示切換
        document.getElementById('showParkList').addEventListener('change', function(e) {
            updateParkDetailList();
        });

        document.getElementById('showOnlyVisible').addEventListener('change', function(e) {
            updateParkDetailList();
        });

        // 篩選條件變化時更新地圖
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateMap);
        });

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateMap);
        });

        // 初始化地圖
        updateMap();

    </script>
</body>
</html>
