<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµæµªå…¬åœ’åœ–å°</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: 80vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .map-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .filter-section {
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(145deg, #f0f4f8, #e2e8f0);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }

        .filter-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #4a5568;
            transition: color 0.2s;
        }

        .filter-group label:hover {
            color: #2d3748;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .range-slider {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 5px;
        }

        .legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e2e8f0;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .search-suggestion:hover {
            background-color: #f8f9fa;
        }

        .search-suggestion:last-child {
            border-bottom: none;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .leaflet-popup-content {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .popup-content h4 {
            color: #2d3748;
            margin-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .popup-content p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 8px 0;
        }

        .star {
            color: #ffd700;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: 2;
                max-height: 400px;
            }
            
            .map-container {
                order: 1;
                height: 50vh;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }

        .btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .facility-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
        }

        /* æ”¶å…¥å€åŸŸå¢é›†æ¨£å¼ */
        .income-cluster {
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid #333;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 1;
            color: #333;
        }

        .income-cluster.high-income {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .income-cluster.medium-high-income {
            border-color: #FF9800;
            color: #FF9800;
        }

        .income-cluster.medium-income {
            border-color: #2196F3;
            color: #2196F3;
        }

        .income-cluster.low-medium-income {
            border-color: #9C27B0;
            color: #9C27B0;
        }

        .search-container {
            position: relative;
        }

        .ranking-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .ranking-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .ranking-item:hover {
            background-color: #f8f9fa;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .ranking-score {
            float: right;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .score-badge {
            display: inline-block;
            background: rgba(33, 150, 243, 0.1);
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
            font-weight: bold;
        }

        .park-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .park-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .park-item:hover {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            transform: translateX(2px);
        }

        .park-item:last-child {
            border-bottom: none;
        }

        .park-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .park-score {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .park-info {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        .park-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 6px;
            font-size: 0.75rem;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            font-weight: bold;
            color: #495057;
        }

        .stat-value {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-tree"></i> æµæµªå…¬åœ’åœ–å°</h1>
            <p>å°‹æ‰¾é©åˆå¤œå®¿çš„å®‰å…¨å…¬åœ’ï¼Œæä¾›å®Œæ•´çš„è¨­æ–½èˆ‡å‘¨é‚Šè³‡è¨Š</p>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="ğŸ” æœå°‹å…¬åœ’åç¨±..." id="searchBox">
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>
                
                <div class="filter-section">
                    <h3><i class="fas fa-star"></i> å¤œå®¿é©å®œåº¦</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="highSuitability" checked> â­ é«˜é©å®œåº¦ (8-10åˆ†)</label>
                        <label><input type="checkbox" id="mediumSuitability" checked> ğŸ”¶ ä¸­é©å®œåº¦ (5-7åˆ†)</label>
                        <label><input type="checkbox" id="lowSuitability"> âŒ ä½é©å®œåº¦ (1-4åˆ†)</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-home"></i> å¿…è¦è¨­æ–½</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="shelter"> ğŸ  é®è”½è¨­æ–½</label>
                        <label><input type="checkbox" id="bench"> ğŸª‘ åº§æ¤…/é•·æ¤…</label>
                        <label><input type="checkbox" id="water"> ğŸ’§ é£²æ°´è¨­æ–½</label>
                        <label><input type="checkbox" id="toilet"> ğŸš» å…¬å…±å»æ‰€</label>
                        <label><input type="checkbox" id="lighting"> ğŸ’¡ å¤œé–“ç…§æ˜</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-subway"></i> äº¤é€šä¾¿åˆ©æ€§</h3>
                    <div class="filter-group">
                        <label>æ·é‹ç«™è·é›¢ (å…¬å°º)</label>
                        <input type="range" class="range-slider" id="mrtDistance" min="0" max="2000" value="1000" step="100">
                        <div class="range-value" id="mrtValue">1000å…¬å°ºå…§</div>
                    </div>
                    <div class="filter-group">
                        <label>å…¬è»Šç«™è·é›¢ (å…¬å°º)</label>
                        <input type="range" class="range-slider" id="busDistance" min="0" max="1000" value="500" step="50">
                        <div class="range-value" id="busValue">500å…¬å°ºå…§</div>
                    </div>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showMRT" checked> é¡¯ç¤ºæ·é‹ç«™</label>
                        <label><input type="checkbox" id="showBus" checked> é¡¯ç¤ºå…¬è»Šç«™</label>
                        <label><input type="checkbox" id="showBike"> é¡¯ç¤ºYouBike</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-dollar-sign"></i> æ”¶å…¥å€åŸŸç¯©é¸</h3>
                    <div class="filter-group">
                        <label>å€åŸŸå¹³å‡æ”¶å…¥ (è¬å…ƒ/æœˆ)</label>
                        <input type="range" class="range-slider" id="incomeRange" min="25" max="80" value="60" step="5">
                        <div class="range-value" id="incomeValue">60è¬ä»¥ä¸‹å€åŸŸ</div>
                    </div>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showIncomeLayer" checked> é¡¯ç¤ºæ”¶å…¥åˆ†æåœ–å±¤</label>
                        <label><input type="checkbox" id="onlySelectedIncome"> åƒ…é¡¯ç¤ºé¸å®šæ”¶å…¥å€åŸŸ</label>
                        <label><input type="checkbox" id="showIncomeCluster" checked> é¡¯ç¤ºæ”¶å…¥å€åŸŸå¢é›†</label>
                    </div>
                    <div class="filter-group">
                        <label>æ”¶å…¥å€åŸŸåœ“åœˆåŠå¾‘ (å…¬å°º) - å½±éŸ¿ç¯„åœ</label>
                        <input type="range" class="range-slider" id="incomeCircleRadius" min="300" max="1500" value="700" step="50">
                        <div class="range-value" id="incomeCircleRadiusValue">700å…¬å°º</div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-store"></i> ç”Ÿæ´»æ©Ÿèƒ½</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="convenience" checked> ğŸª ä¾¿åˆ©å•†åº—</label>
                        <label><input type="checkbox" id="pharmacy"> ğŸ’Š è—¥å±€</label>
                        <label><input type="checkbox" id="restaurant"> ğŸ” é¤å»³</label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-circle-dot"></i> ä»¥å…¬åœ’ç‚ºä¸­å¿ƒçš„åŠŸèƒ½åœ“åœˆ</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showWalkingRange" checked> ğŸš¶ æ­¥è¡Œèˆ’é©ç¯„åœ</label>
                        <label><input type="checkbox" id="showTransportRange" checked> ğŸšŒ äº¤é€šå¯åŠç¯„åœ</label>
                        <label><input type="checkbox" id="showLifeRange"> ğŸª ç”Ÿæ´»æ©Ÿèƒ½ç¯„åœ</label>
                        <label><input type="checkbox" id="showSafetyRange"> ğŸ›¡ï¸ å®‰å…¨å½±éŸ¿ç¯„åœ</label>
                        <label><input type="checkbox" id="showParkLabels" checked> ğŸ·ï¸ é¡¯ç¤ºå…¬åœ’åç¨±</label>
                    </div>
                    <div class="filter-group">
                        <label>æ­¥è¡Œèˆ’é©ç¯„åœ (å…¬å°º) - é©åˆæ—¥å¸¸æ´»å‹•</label>
                        <input type="range" class="range-slider" id="walkingRadius" min="100" max="500" value="200" step="25">
                        <div class="range-value" id="walkingRadiusValue">200å…¬å°º</div>
                    </div>
                    <div class="filter-group">
                        <label>äº¤é€šå¯åŠç¯„åœ (å…¬å°º) - èƒ½åˆ°é”äº¤é€šç«™é»</label>
                        <input type="range" class="range-slider" id="transportRadius" min="300" max="1200" value="600" step="50">
                        <div class="range-value" id="transportRadiusValue">600å…¬å°º</div>
                    </div>
                    <div class="filter-group">
                        <label>ç”Ÿæ´»æ©Ÿèƒ½ç¯„åœ (å…¬å°º) - ä¾¿åˆ©å•†åº—ã€é¤å»³ç­‰</label>
                        <input type="range" class="range-slider" id="lifeRadius" min="400" max="1000" value="800" step="50">
                        <div class="range-value" id="lifeRadiusValue">800å…¬å°º</div>
                    </div>
                    <div class="filter-group">
                        <label>å®‰å…¨å½±éŸ¿ç¯„åœ (å…¬å°º) - å‘¨é‚Šç’°å¢ƒå®‰å…¨åº¦</label>
                        <input type="range" class="range-slider" id="safetyRadius" min="200" max="800" value="400" step="50">
                        <div class="range-value" id="safetyRadiusValue">400å…¬å°º</div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-star"></i> ç¶œåˆè©•åˆ†è¨­å®š</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="enableScoring" checked> ğŸ“Š å•Ÿç”¨ç¶œåˆè©•åˆ†</label>
                        <label><input type="checkbox" id="showScoreRanking"> ğŸ† é¡¯ç¤ºè©•åˆ†æ’å</label>
                    </div>
                    <div class="filter-group">
                        <label>äº¤é€šä¾¿åˆ©æ€§æ¬Šé‡ (%)</label>
                        <input type="range" class="range-slider" id="transportWeight" min="0" max="100" value="35" step="5">
                        <div class="range-value" id="transportWeightValue">35%</div>
                    </div>
                    <div class="filter-group">
                        <label>è¨­æ–½å®Œå–„åº¦æ¬Šé‡ (%)</label>
                        <input type="range" class="range-slider" id="facilityWeight" min="0" max="100" value="25" step="5">
                        <div class="range-value" id="facilityWeightValue">25%</div>
                    </div>
                    <div class="filter-group">
                        <label>å¤œå®¿é©å®œåº¦æ¬Šé‡ (%)</label>
                        <input type="range" class="range-slider" id="suitabilityWeight" min="0" max="100" value="30" step="5">
                        <div class="range-value" id="suitabilityWeightValue">30%</div>
                    </div>
                    <div class="filter-group">
                        <label>å®‰å…¨è©•åˆ†æ¬Šé‡ (%)</label>
                        <input type="range" class="range-slider" id="safetyWeight" min="0" max="100" value="10" step="5">
                        <div class="range-value" id="safetyWeightValue">10%</div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-list"></i> å…¬åœ’è©³ç´°åˆ—è¡¨</h3>
                    <div class="filter-group">
                        <label><input type="checkbox" id="showParkList" checked> ğŸ“‹ é¡¯ç¤ºå…¬åœ’åˆ—è¡¨</label>
                        <label><input type="checkbox" id="showOnlyVisible"> ğŸ‘ï¸ åƒ…é¡¯ç¤ºå¯è¦‹å…¬åœ’</label>
                    </div>
                </div>

                <div class="filter-section" id="parkListSection">
                    <h3><i class="fas fa-map-marker-alt"></i> å…¬åœ’è³‡è¨Š</h3>
                    <div id="parkDetailList" class="park-list">
                        <!-- å…¬åœ’è©³ç´°åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>

                <div class="legend">
                    <h4>åœ–ä¾‹èªªæ˜</h4>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4CAF50;"></span>
                        é«˜é©å®œåº¦å…¬åœ’ (8-10åˆ†)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #FF9800;"></span>
                        ä¸­é©å®œåº¦å…¬åœ’ (5-7åˆ†)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #F44336;"></span>
                        ä½é©å®œåº¦å…¬åœ’ (1-4åˆ†)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #2196F3;"></span>
                        æ·é‹ç«™ / BRTç«™
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #FF5722;"></span>
                        å…¬è»Šç«™
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4CAF50;"></span>
                        é«˜æ”¶å…¥å€ (60è¬+)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #FF9800;"></span>
                        ä¸­é«˜æ”¶å…¥å€ (45-60è¬)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #2196F3;"></span>
                        ä¸­ç­‰æ”¶å…¥å€ (35-45è¬)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #9C27B0;"></span>
                        ä¸­ä½æ”¶å…¥å€ (25-35è¬)
                    </div>
                </div>

                <button class="btn" onclick="resetFilters()">
                    <i class="fas fa-refresh"></i> é‡ç½®ç¯©é¸
                </button>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="info-panel" id="infoPanel">
                    <h4 id="infoPanelTitle">è³‡è¨Šé¢æ¿</h4>
                    <div id="infoPanelContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // åˆå§‹åŒ–åœ°åœ– (ä»¥å°ä¸­å¸‚ä¸­å¿ƒç‚ºä¸­å¿ƒ)
        let map = L.map('map').setView([24.1477, 120.6736], 12);

        // æ·»åŠ åº•åœ– - ä½¿ç”¨æ›´ç°¡æ½”çš„CartoDBåœ°åœ–
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // åœ–å±¤ç¾¤çµ„
        let parkLayers = L.layerGroup().addTo(map);
        let walkingRangeLayers = L.layerGroup().addTo(map);
        let transportRangeLayers = L.layerGroup().addTo(map);
        let lifeRangeLayers = L.layerGroup().addTo(map);
        let safetyRangeLayers = L.layerGroup().addTo(map);
        let parkLabelLayers = L.layerGroup().addTo(map);
        let transportLayers = L.layerGroup().addTo(map);
        let facilityLayers = L.layerGroup().addTo(map);
        let incomeCircleLayers = L.layerGroup().addTo(map);
        let incomeClusterGroup = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                const markers = cluster.getAllChildMarkers();
                const avgIncome = markers.reduce((sum, marker) => sum + marker.options.income, 0) / markers.length;
                
                let className = 'income-cluster';
                if (avgIncome >= 60) className += ' high-income';
                else if (avgIncome >= 45) className += ' medium-high-income';
                else if (avgIncome >= 35) className += ' medium-income';
                else className += ' low-medium-income';
                
                return L.divIcon({
                    html: '<div class="' + className + '">' + markers.length + '</div>',
                    className: 'marker-cluster',
                    iconSize: L.point(40, 40)
                });
            },
            maxClusterRadius: 80
        }).addTo(map);

        const incomeAreas = [
            // é«˜æ”¶å…¥å€åŸŸ (60è¬ä»¥ä¸Š)
            {name: "ä¸ƒæœŸé‡åŠƒå€", bounds: [[24.1589, 120.6312], [24.1723, 120.6445]], income: 75, level: "é«˜æ”¶å…¥å€"},
            {name: "è¥¿å±¯æƒ ä¾†é‡Œ", bounds: [[24.1634, 120.6223], [24.1756, 120.6356]], income: 72, level: "é«˜æ”¶å…¥å€"},
            {name: "å—å±¯è±å¯Œé‡Œ", bounds: [[24.1423, 120.6189], [24.1512, 120.6312]], income: 68, level: "é«˜æ”¶å…¥å€"},
            {name: "åŒ—å±¯å»å­é‡åŠƒå€", bounds: [[24.1789, 120.7012], [24.1878, 120.7145]], income: 65, level: "é«˜æ”¶å…¥å€"},
            {name: "è¥¿å€ç¾è¡“åœ’é“", bounds: [[24.1501, 120.6567], [24.1578, 120.6689]], income: 63, level: "é«˜æ”¶å…¥å€"},
            
            // ä¸­é«˜æ”¶å…¥å€åŸŸ (45-60è¬)
            {name: "åŒ—å±¯æ¾ç«¹å€", bounds: [[24.1789, 120.6823], [24.1889, 120.6923]], income: 58, level: "ä¸­é«˜æ”¶å…¥å€"},
            {name: "è¥¿å±¯æœé¦¬å€", bounds: [[24.1689, 120.6123], [24.1756, 120.6234]], income: 55, level: "ä¸­é«˜æ”¶å…¥å€"},
            {name: "å—å€èˆˆå¤§å€", bounds: [[24.1201, 120.6789], [24.1289, 120.6889]], income: 52, level: "ä¸­é«˜æ”¶å…¥å€"},
            {name: "åŒ—å€ä¸€ä¸­å•†åœˆ", bounds: [[24.1534, 120.6712], [24.1634, 120.6823]], income: 50, level: "ä¸­é«˜æ”¶å…¥å€"},
            {name: "æ–‡å¿ƒæ£®æ—å…¬åœ’å‘¨é‚Š", bounds: [[24.1356, 120.6423], [24.1423, 120.6489]], income: 48, level: "ä¸­é«˜æ”¶å…¥å€"},
            
            // ä¸­ç­‰æ”¶å…¥å€åŸŸ (35-45è¬)
            {name: "æ±å€æ¨‚æˆå€", bounds: [[24.1334, 120.6889], [24.1423, 120.6989]], income: 42, level: "ä¸­ç­‰æ”¶å…¥å€"},
            {name: "ä¸­å€å°ä¸­è»Šç«™", bounds: [[24.1389, 120.6789], [24.1478, 120.6889]], income: 40, level: "ä¸­ç­‰æ”¶å…¥å€"},
            {name: "å¤ªå¹³æ–°å…‰å€", bounds: [[24.1123, 120.7123], [24.1234, 120.7234]], income: 38, level: "ä¸­ç­‰æ”¶å…¥å€"},
            {name: "å¤§é‡Œè‰æ¹–å€", bounds: [[24.0889, 120.6789], [24.1023, 120.6889]], income: 36, level: "ä¸­ç­‰æ”¶å…¥å€"},
            {name: "è±åŸå¸‚ä¸­å¿ƒ", bounds: [[24.2456, 120.7156], [24.2567, 120.7267]], income: 35, level: "ä¸­ç­‰æ”¶å…¥å€"},
            
            // ä¸­ä½æ”¶å…¥å€åŸŸ (25-35è¬)
            {name: "çƒæ—¥å€", bounds: [[24.1023, 120.6123], [24.1156, 120.6267]], income: 32, level: "ä¸­ä½æ”¶å…¥å€"},
            {name: "éœ§å³°å€", bounds: [[24.0589, 120.6889], [24.0723, 120.7023]], income: 30, level: "ä¸­ä½æ”¶å…¥å€"},
            {name: "æ½­å­é ­å®¶å€", bounds: [[24.2089, 120.6889], [24.2189, 120.6989]], income: 28, level: "ä¸­ä½æ”¶å…¥å€"},
            {name: "å¤§é›…å€", bounds: [[24.2223, 120.6456], [24.2334, 120.6567]], income: 27, level: "ä¸­ä½æ”¶å…¥å€"},
            {name: "æ¸…æ°´å€", bounds: [[24.2589, 120.5623], [24.2723, 120.5756]], income: 25, level: "ä¸­ä½æ”¶å…¥å€"}
        ];

        // å°ä¸­å…¬è»Šç«™è³‡æ–™
        const busData = [
            // ä¸»è¦å…¬è»Šç«™
            {name: "å°ä¸­è»Šç«™", lat: 24.1369, lng: 120.6863, routes: ["1", "6", "9", "14", "15", "18", "21", "35", "71", "100", "101", "102", "103", "105", "106", "107", "108"]},
            {name: "ä¸­å‹ç™¾è²¨", lat: 24.1534, lng: 120.6823, routes: ["6", "9", "33", "35", "41", "61", "71", "131", "132", "142", "146"]},
            {name: "ä¸€ä¸­å•†åœˆ", lat: 24.1556, lng: 120.6789, routes: ["6", "9", "33", "35", "41", "61", "71", "131", "132", "142"]},
            {name: "ç§‘åšé¤¨", lat: 24.1523, lng: 120.6723, routes: ["11", "23", "35", "37", "71", "75", "83", "102", "103", "105"]},
            {name: "å»£ä¸‰SOGO", lat: 24.1489, lng: 120.6689, routes: ["11", "23", "35", "37", "71", "75", "83", "102", "103"]},
            {name: "æ–‡å¿ƒæ£®æ—å…¬åœ’", lat: 24.1389, lng: 120.6456, routes: ["23", "53", "73", "77", "290", "356", "359"]},
            {name: "è±æ¨‚å…¬åœ’", lat: 24.1278, lng: 120.6534, routes: ["53", "73", "77", "290", "356", "359"]},
            {name: "ç§‹ç´…è°·", lat: 24.1634, lng: 120.6334, routes: ["25", "45", "161", "323", "324", "325", "326"]},
            {name: "æœé¦¬", lat: 24.1723, lng: 120.6234, routes: ["25", "45", "161", "323", "324", "325", "326"]},
            {name: "æ–°å…‰ä¸‰è¶Š", lat: 24.1656, lng: 120.6389, routes: ["25", "45", "161", "323", "324", "325"]},
            {name: "å¸‚æ”¿åºœ", lat: 24.1623, lng: 120.6445, routes: ["25", "45", "161", "323", "324", "325"]},
            {name: "è±åŸè»Šç«™", lat: 24.2523, lng: 120.7234, routes: ["12", "63", "90", "91", "92", "93", "186", "206", "207", "208", "209", "213", "218", "220", "227", "228", "229", "235", "236", "237", "238", "239"]},
            {name: "å¤§é‡Œè»Šç«™", lat: 24.0998, lng: 120.6789, routes: ["50", "53", "59", "74", "100", "107", "108", "131", "132", "201", "280", "285"]},
            {name: "å¤ªå¹³è»Šç«™", lat: 24.1234, lng: 120.7234, routes: ["15", "41", "74", "163", "280", "285", "286", "287", "288"]},
            {name: "çƒæ—¥è»Šç«™", lat: 24.1089, lng: 120.6234, routes: ["26", "69", "99", "102", "105", "617", "655"]},
            {name: "éœ§å³°", lat: 24.0678, lng: 120.6923, routes: ["50", "59", "201", "281", "282", "283", "284"]},
            {name: "æ½­å­è»Šç«™", lat: 24.2123, lng: 120.7034, routes: ["63", "65", "178", "900", "901", "920", "921", "922"]},
            {name: "å¤§é›…", lat: 24.2289, lng: 120.6534, routes: ["65", "128", "133", "154", "700", "701", "704"]},
            {name: "ç¥å²¡", lat: 24.2456, lng: 120.6712, routes: ["63", "65", "154", "700", "701", "704"]},
            {name: "åé‡Œè»Šç«™", lat: 24.3123, lng: 120.7156, routes: ["155", "214", "215", "616", "811", "813"]},
            {name: "æ±å‹¢", lat: 24.2634, lng: 120.8234, routes: ["153", "206", "207", "208", "209", "850", "865", "866", "867"]},
            {name: "æ¸…æ°´è»Šç«™", lat: 24.2645, lng: 120.5689, routes: ["111", "115", "123", "128", "166", "167", "168", "169", "170", "171", "172", "173", "174", "175", "176", "177", "178", "179", "180", "181", "182", "183", "184", "185"]},
            {name: "æ²™é¹¿è»Šç«™", lat: 24.2345, lng: 120.5689, routes: ["166", "167", "168", "169", "170", "171", "172", "173", "174"]},
            {name: "æ¢§æ£²", lat: 24.2890, lng: 120.5234, routes: ["123", "128", "166", "167", "168", "169"]},
            {name: "é¾äº•è»Šç«™", lat: 24.1923, lng: 120.5456, routes: ["617", "655", "656", "657", "658", "659"]},
            {name: "å¤§ç”²è»Šç«™", lat: 24.3456, lng: 120.6234, routes: ["185", "186", "187", "188", "189", "190", "191", "192", "193", "194", "195"]}
        ];

        // å°ä¸­å¸‚å…¬åœ’è³‡æ–™ (100+å€‹é»ä½)
        const parkData = [
            // ä¸­å€
            {name: "å°ä¸­å…¬åœ’", lat: 24.1441, lng: 120.6813, suitability: 8, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "å°ä¸­å¸‚æœ€å…·æ­·å²çš„å…¬åœ’ï¼Œæ¹–å¿ƒäº­ç‚ºåœ°æ¨™ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "ä¸­å±±å…¬åœ’", lat: 24.1401, lng: 120.6789, suitability: 7, facilities: ["bench", "lighting"], description: "å¸‚ä¸­å¿ƒå°å‹å…¬åœ’ï¼Œäº¤é€šä¾¿åˆ©ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "æ°‘æ¬Šå…¬åœ’", lat: 24.1456, lng: 120.6834, suitability: 6, facilities: ["bench", "water"], description: "ç¤¾å€å‹å…¬åœ’ï¼Œè¨­æ–½ç°¡å–®ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            
            // æ±å€
            {name: "æ¨‚æˆå…¬åœ’", lat: 24.1378, lng: 120.6912, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "è¨­æ–½å®Œå–„çš„å¤§å‹å…¬åœ’ï¼Œé©åˆå¤œå®¿ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 9},
            {name: "æ—±æºªæ±è·¯å…¬åœ’", lat: 24.1345, lng: 120.6987, suitability: 7, facilities: ["shelter", "bench", "lighting"], description: "æ²³å²¸å…¬åœ’ï¼Œç’°å¢ƒæ¸…å¹½ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "æ±é–€å…¬åœ’", lat: 24.1412, lng: 120.6923, suitability: 6, facilities: ["bench", "water"], description: "å°å‹é„°é‡Œå…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            {name: "å¾©èˆˆå…¬åœ’", lat: 24.1389, lng: 120.6945, suitability: 8, facilities: ["shelter", "bench", "toilet", "lighting"], description: "ç¤¾å€ä¸­å¿ƒå‹å…¬åœ’ï¼Œå®‰å…¨æ€§ä½³ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "é€²å¾·å…¬åœ’", lat: 24.1356, lng: 120.6967, suitability: 5, facilities: ["bench"], description: "è¼ƒå°çš„ç¤¾å€å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 5},
            
            // è¥¿å€
            {name: "è‰æ‚Ÿé“", lat: 24.1519, lng: 120.6644, suitability: 7, facilities: ["lighting", "bench"], description: "çŸ¥åç¶ åœ’é“ï¼Œä½†å¤œé–“è¼ƒå¤šäººç¾¤ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 7},
            {name: "ç¾è¡“åœ’é“", lat: 24.1534, lng: 120.6623, suitability: 6, facilities: ["bench", "lighting"], description: "è—æ–‡å€åŸŸï¼Œç’°å¢ƒå„ªç¾ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 6},
            {name: "å¿ æ˜å…¬åœ’", lat: 24.1487, lng: 120.6578, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "è¨­æ–½è‰¯å¥½çš„ä½å®…å€å…¬åœ’ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 8},
            {name: "å‘ä¸Šå…¬åœ’", lat: 24.1423, lng: 120.6545, suitability: 7, facilities: ["bench", "water", "lighting"], description: "ç¤¾å€å…¬åœ’ï¼Œç’°å¢ƒæ•´æ½”ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "è‹±æ‰å…¬åœ’", lat: 24.1456, lng: 120.6612, suitability: 6, facilities: ["bench", "lighting"], description: "æ ¡åœ’é™„è¿‘å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            
            // å—å€
            {name: "èˆˆå¤§åº·æ©‹", lat: 24.1245, lng: 120.6823, suitability: 8, facilities: ["shelter", "bench", "water", "lighting"], description: "å¤§å­¸é™„è¿‘ï¼Œç’°å¢ƒå„ªç¾ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "ä¸­èˆˆå¤§å­¸æ ¡åœ’", lat: 24.1234, lng: 120.6798, suitability: 7, facilities: ["bench", "water", "toilet"], description: "æ ¡åœ’ç¶ åœ°ï¼Œå¤œé–“è¼ƒå®‰éœã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "æ–‡å¿ƒæ£®æ—å…¬åœ’", lat: 24.1389, lng: 120.6456, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "å¤§å‹æ£®æ—å…¬åœ’ï¼Œè¨­æ–½å®Œå–„ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 9},
            {name: "è±æ¨‚é›•å¡‘å…¬åœ’", lat: 24.1278, lng: 120.6534, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "è—è¡“ä¸»é¡Œå…¬åœ’ï¼Œç’°å¢ƒä½³ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "å—å±¯å…¬åœ’", lat: 24.1234, lng: 120.6456, suitability: 6, facilities: ["bench", "lighting"], description: "ç¤¾å€å‹å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            
            // åŒ—å€
            {name: "åŒ—å±¯å…’ç«¥å…¬åœ’", lat: 24.1612, lng: 120.6823, suitability: 7, facilities: ["shelter", "bench", "water"], description: "è¦ªå­å…¬åœ’ï¼Œè¨­æ–½è¼ƒæ–°ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "æ–°æ°‘å…¬åœ’", lat: 24.1578, lng: 120.6756, suitability: 6, facilities: ["bench", "lighting"], description: "ä½å®…å€å°å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            {name: "å¥è¡Œå…¬åœ’", lat: 24.1623, lng: 120.6789, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "é‹å‹•ä¼‘é–’å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "ä¸­æ¸…å…¬åœ’", lat: 24.1645, lng: 120.6712, suitability: 5, facilities: ["bench"], description: "è¼ƒå°å‹çš„ç¤¾å€å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 5},
            
            // åŒ—å±¯å€
            {name: "å»å­å…¬åœ’", lat: 24.1812, lng: 120.7123, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "æ–°èˆˆå€åŸŸå¤§å‹å…¬åœ’ï¼Œè¨­æ–½å®Œå–„ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 9},
            {name: "å››ç¶­å…¬åœ’", lat: 24.1734, lng: 120.6998, suitability: 7, facilities: ["bench", "water", "lighting"], description: "ä½å®…å€å…¬åœ’ï¼Œç’°å¢ƒæ¸…å¹½ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "åŒ—å±¯å…¬åœ’", lat: 24.1698, lng: 120.6923, suitability: 8, facilities: ["shelter", "bench", "toilet", "lighting"], description: "å€åŸŸæ€§å…¬åœ’ï¼Œè¨­æ–½è‰¯å¥½ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "æ¾ç«¹å…¬åœ’", lat: 24.1823, lng: 120.6876, suitability: 6, facilities: ["bench", "lighting"], description: "æ·é‹ç«™é™„è¿‘å°å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            {name: "è»åŠŸå…¬åœ’", lat: 24.1856, lng: 120.7034, suitability: 7, facilities: ["shelter", "bench", "water"], description: "å±±å€é‚Šç·£å…¬åœ’ï¼Œç©ºæ°£ä½³ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            
            // è¥¿å±¯å€
            {name: "ç§‹ç´…è°·ç”Ÿæ…‹å…¬åœ’", lat: 24.1634, lng: 120.6334, suitability: 8, facilities: ["shelter", "bench", "lighting"], description: "çŸ¥åç”Ÿæ…‹å…¬åœ’ï¼Œä½†å¤œé–“äººæµå¤šã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 7},
            {name: "æœé¦¬å…¬åœ’", lat: 24.1723, lng: 120.6234, suitability: 6, facilities: ["bench", "water"], description: "äº¤é€šè¦é“æ—å…¬åœ’ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 6},
            {name: "ç¦å®‰å…¬åœ’", lat: 24.1689, lng: 120.6145, suitability: 7, facilities: ["shelter", "bench", "toilet"], description: "ä½å®…å€å…¬åœ’ï¼Œè¨­æ–½ä¸­ç­‰ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 7},
            {name: "ä½•åå…¬åœ’", lat: 24.1756, lng: 120.6278, suitability: 5, facilities: ["bench"], description: "å°å‹ç¤¾å€å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 5},
            {name: "è¥¿å±¯å…¬åœ’", lat: 24.1612, lng: 120.6156, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "å€åŸŸä¸­å¿ƒå…¬åœ’ï¼Œè¨­æ–½å®Œå–„ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            
            // å—å±¯å€
            {name: "è±å¯Œå…¬åœ’", lat: 24.1456, lng: 120.6312, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "é«˜ç´šä½å®…å€å…¬åœ’ï¼Œè¨­æ–½å„ªè‰¯ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 9},
            {name: "å—å±¯è¦ªå­å…¬åœ’", lat: 24.1378, lng: 120.6234, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "è¦ªå­å‹å–„å…¬åœ’ï¼Œå®‰å…¨æ€§é«˜ã€‚", income_level: "é«˜æ”¶å…¥å€", safety_score: 8},
            {name: "æ˜¥å®‰å…¬åœ’", lat: 24.1423, lng: 120.6189, suitability: 7, facilities: ["bench", "water", "lighting"], description: "ç¤¾å€å…¬åœ’ï¼Œç’°å¢ƒè‰¯å¥½ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "å‘å¿ƒå…¬åœ’", lat: 24.1512, lng: 120.6267, suitability: 6, facilities: ["bench", "lighting"], description: "å°å‹é„°é‡Œå…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            
            // å¤ªå¹³å€
            {name: "å¤ªå¹³è²·è¸å ´", lat: 24.1234, lng: 120.7234, suitability: 7, facilities: ["shelter", "bench", "water"], description: "æ–‡å‰µåœ’å€ç¶ åœ°ï¼Œç’°å¢ƒç‰¹æ®Šã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "é ­æ±´å‘è™è æ´å…¬åœ’", lat: 24.1123, lng: 120.7345, suitability: 5, facilities: ["bench"], description: "å±±å€å…¬åœ’ï¼Œè¼ƒååƒ»ã€‚", income_level: "ä½æ”¶å…¥å€", safety_score: 4},
            {name: "å¤ªå¹³å…¬åœ’", lat: 24.1189, lng: 120.7198, suitability: 8, facilities: ["shelter", "bench", "water", "toilet"], description: "å€åŸŸä¸»è¦å…¬åœ’ï¼Œè¨­æ–½å®Œå–„ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "æ–°å…‰å…¬åœ’", lat: 24.1145, lng: 120.7156, suitability: 6, facilities: ["bench", "lighting"], description: "ä½å®…å€å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            
            // å¤§é‡Œå€
            {name: "å¤§é‡Œæ™å…¬åœ’", lat: 24.0998, lng: 120.6789, suitability: 8, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "å¤§é‡Œä¸»è¦å…¬åœ’ï¼Œè¨­æ–½è‰¯å¥½ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "è‰æ¹–å…¬åœ’", lat: 24.0923, lng: 120.6834, suitability: 6, facilities: ["bench", "water"], description: "ç¤¾å€å‹å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            {name: "å¡—åŸå…¬åœ’", lat: 24.1034, lng: 120.6712, suitability: 7, facilities: ["shelter", "bench", "lighting"], description: "ä½å®…å€å…¬åœ’ï¼Œç’°å¢ƒæ•´æ½”ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "å¥æ°‘å…¬åœ’", lat: 24.0989, lng: 120.6756, suitability: 5, facilities: ["bench"], description: "å°å‹å…¬åœ’ï¼Œè¨­æ–½ç°¡å–®ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 5},
            
            // çƒæ—¥å€
            {name: "çƒæ—¥å•¤é…’è§€å…‰å·¥å» ", lat: 24.1089, lng: 120.6234, suitability: 6, facilities: ["shelter", "bench"], description: "è§€å…‰å·¥å» ç¶ åœ°ï¼Œç™½å¤©è¼ƒç†±é¬§ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            {name: "çƒæ—¥å…¬åœ’", lat: 24.1056, lng: 120.6178, suitability: 7, facilities: ["bench", "water", "toilet"], description: "å€åŸŸå…¬åœ’ï¼ŒåŸºæœ¬è¨­æ–½é½Šå…¨ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "æºªå°¾å…¬åœ’", lat: 24.1123, lng: 120.6145, suitability: 5, facilities: ["bench"], description: "å°å‹ç¤¾å€å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 5},
            
            // éœ§å³°å€
            {name: "éœ§å³°æ—å®¶èŠ±åœ’", lat: 24.0634, lng: 120.6998, suitability: 6, facilities: ["shelter", "bench"], description: "å¤è¹Ÿåœ’å€ï¼Œç’°å¢ƒå„ªç¾ä½†æœ‰ç®¡åˆ¶ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            {name: "éœ§å³°å…¬åœ’", lat: 24.0678, lng: 120.6923, suitability: 7, facilities: ["bench", "water", "lighting"], description: "å€åŸŸä¸­å¿ƒå…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "å…‰å¾©å…¬åœ’", lat: 24.0712, lng: 120.6878, suitability: 5, facilities: ["bench"], description: "ä½å®…å€å°å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 5},
            
            // è±åŸå€
            {name: "è±åŸå…¬åœ’", lat: 24.2523, lng: 120.7234, suitability: 8, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "è±åŸä¸»è¦å…¬åœ’ï¼Œè¨­æ–½å®Œå–„ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 8},
            {name: "å»Ÿæ±å¤œå¸‚æ—å…¬åœ’", lat: 24.2489, lng: 120.7198, suitability: 4, facilities: ["bench"], description: "å¤œå¸‚æ—å°å…¬åœ’ï¼Œå¤œé–“è¼ƒåµé›œã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 4},
            {name: "å—é™½å…¬åœ’", lat: 24.2556, lng: 120.7156, suitability: 7, facilities: ["shelter", "bench", "water"], description: "ä½å®…å€å…¬åœ’ï¼Œç’°å¢ƒæ¸…å¹½ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "è±æ±å…¬åœ’", lat: 24.2534, lng: 120.7289, suitability: 6, facilities: ["bench", "lighting"], description: "ç¤¾å€å‹å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6},
            
            // æ½­å­å€
            {name: "æ½­å­é‹å‹•å…¬åœ’", lat: 24.2123, lng: 120.7034, suitability: 9, facilities: ["shelter", "bench", "water", "toilet", "lighting"], description: "å¤§å‹é‹å‹•å…¬åœ’ï¼Œè¨­æ–½å®Œå–„ä¸”å®‰å…¨ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 9},
            {name: "æ½­å­å…¬åœ’", lat: 24.2089, lng: 120.6998, suitability: 7, facilities: ["bench", "water", "lighting"], description: "å€åŸŸä¸­å¿ƒå…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 7},
            {name: "é ­å®¶å…¬åœ’", lat: 24.2156, lng: 120.6923, suitability: 6, facilities: ["bench", "lighting"], description: "ä½å®…å€å…¬åœ’ã€‚", income_level: "ä¸­æ”¶å…¥å€", safety_score: 6}
        ];

        // å°ä¸­æ·é‹ç«™è³‡æ–™
        const mrtData = [
            // ç¶ ç·š (çƒæ—¥æ–‡å¿ƒåŒ—å±¯ç·š)
            {name: "åŒ—å±¯ç¸½ç«™", lat: 24.1612, lng: 120.6834, line: "ç¶ ç·š"},
            {name: "èˆŠç¤¾ç«™", lat: 24.1589, lng: 120.6823, line: "ç¶ ç·š"},
            {name: "æ¾ç«¹ç«™", lat: 24.1534, lng: 120.6812, line: "ç¶ ç·š"},
            {name: "å››ç¶­åœ‹å°ç«™", lat: 24.1498, lng: 120.6801, line: "ç¶ ç·š"},
            {name: "å´‡å¾·æ–‡å¿ƒç«™", lat: 24.1467, lng: 120.6789, line: "ç¶ ç·š"},
            {name: "ä¸­æ¸…æ–‡å¿ƒç«™", lat: 24.1423, lng: 120.6778, line: "ç¶ ç·š"},
            {name: "æ–‡è¯é«˜ä¸­ç«™", lat: 24.1389, lng: 120.6767, line: "ç¶ ç·š"},
            {name: "æ«»èŠ±æ–‡å¿ƒç«™", lat: 24.1356, lng: 120.6756, line: "ç¶ ç·š"},
            {name: "å¸‚æ”¿åºœç«™", lat: 24.1623, lng: 120.6445, line: "ç¶ ç·š"},
            {name: "æ°´å®‰å®®ç«™", lat: 24.1598, lng: 120.6434, line: "ç¶ ç·š"},
            {name: "æ–‡å¿ƒæ£®æ—å…¬åœ’ç«™", lat: 24.1389, lng: 120.6456, line: "ç¶ ç·š"},
            {name: "å—å±¯ç«™", lat: 24.1312, lng: 120.6423, line: "ç¶ ç·š"},
            {name: "è±æ¨‚å…¬åœ’ç«™", lat: 24.1278, lng: 120.6534, line: "ç¶ ç·š"},
            {name: "å¤§æ…¶ç«™", lat: 24.1134, lng: 120.6389, line: "ç¶ ç·š"},
            {name: "ä¹å¼µçŠç«™", lat: 24.1089, lng: 120.6378, line: "ç¶ ç·š"},
            {name: "çƒæ—¥ç«™", lat: 24.1056, lng: 120.6367, line: "ç¶ ç·š"},
            
            // è—ç·š (æ©Ÿå ´æ·é‹å»¶ä¼¸è¦åŠƒ)
            {name: "å°ä¸­è»Šç«™", lat: 24.1369, lng: 120.6863, line: "è—ç·š(è¦åŠƒ)"},
            {name: "äº”æ¬Šç«™", lat: 24.1423, lng: 120.6734, line: "è—ç·š(è¦åŠƒ)"},
            {name: "ä¸­å‹ç™¾è²¨ç«™", lat: 24.1534, lng: 120.6823, line: "è—ç·š(è¦åŠƒ)"},
            
            // æ·é‹å¿«ç·šBRT
            {name: "å°ä¸­ç«è»Šç«™", lat: 24.1369, lng: 120.6863, line: "BRT"},
            {name: "ä»å‹æ±ç«™", lat: 24.1398, lng: 120.6812, line: "BRT"},
            {name: "å½°åŒ–éŠ€è¡Œç«™", lat: 24.1445, lng: 120.6789, line: "BRT"},
            {name: "ä¸­å€å…¬æ‰€ç«™", lat: 24.1467, lng: 120.6767, line: "BRT"},
            {name: "ç¬¬ä¸€å»£å ´ç«™", lat: 24.1489, lng: 120.6745, line: "BRT"},
            {name: "ç§‘åšé¤¨ç«™", lat: 24.1523, lng: 120.6723, line: "BRT"},
            {name: "é ‚ä½•åç«™", lat: 24.1556, lng: 120.6701, line: "BRT"},
            {name: "å¿ æ˜åœ‹å°ç«™", lat: 24.1578, lng: 120.6678, line: "BRT"},
            {name: "ä¸­å±±é†«å¤§ç«™", lat: 24.1612, lng: 120.6656, line: "BRT"},
            {name: "æ²³å—è·¯ç«™", lat: 24.1634, lng: 120.6634, line: "BRT"},
            {name: "æœé¦¬ç«™", lat: 24.1667, lng: 120.6612, line: "BRT"}
        ];

        // å°ä¸­ä¾¿åˆ©å•†åº—è³‡æ–™
        const convenienceData = [
            // ä¸­å€
            {name: "7-ELEVEN å°ä¸­è»Šç«™åº—", lat: 24.1369, lng: 120.6863, type: "7-11"},
            {name: "å…¨å®¶ ä¸­è¯åº—", lat: 24.1445, lng: 120.6823, type: "family"},
            {name: "èŠçˆ¾å¯Œ ä¸­å€åº—", lat: 24.1423, lng: 120.6801, type: "hilife"},
            
            // æ±å€
            {name: "7-ELEVEN æ¨‚æˆåº—", lat: 24.1378, lng: 120.6923, type: "7-11"},
            {name: "å…¨å®¶ æ±é–€åº—", lat: 24.1412, lng: 120.6945, type: "family"},
            {name: "OKä¾¿åˆ©å•†åº— å¾©èˆˆåº—", lat: 24.1389, lng: 120.6967, type: "ok"},
            {name: "7-ELEVEN é€²å¾·åº—", lat: 24.1356, lng: 120.6989, type: "7-11"},
            
            // è¥¿å€
            {name: "7-ELEVEN è‰æ‚Ÿé“åº—", lat: 24.1519, lng: 120.6644, type: "7-11"},
            {name: "å…¨å®¶ ç¾è¡“é¤¨åº—", lat: 24.1534, lng: 120.6623, type: "family"},
            {name: "èŠçˆ¾å¯Œ å¿ æ˜åº—", lat: 24.1487, lng: 120.6578, type: "hilife"},
            {name: "7-ELEVEN å‘ä¸Šåº—", lat: 24.1423, lng: 120.6545, type: "7-11"},
            {name: "OKä¾¿åˆ©å•†åº— è‹±æ‰åº—", lat: 24.1456, lng: 120.6612, type: "ok"},
            
            // å—å€
            {name: "7-ELEVEN èˆˆå¤§åº—", lat: 24.1245, lng: 120.6823, type: "7-11"},
            {name: "å…¨å®¶ æ–‡å¿ƒåº—", lat: 24.1389, lng: 120.6456, type: "family"},
            {name: "7-ELEVEN è±æ¨‚åº—", lat: 24.1278, lng: 120.6534, type: "7-11"},
            {name: "èŠçˆ¾å¯Œ å—å±¯åº—", lat: 24.1234, lng: 120.6456, type: "hilife"},
            
            // åŒ—å€
            {name: "7-ELEVEN ä¸€ä¸­åº—", lat: 24.1578, lng: 120.6756, type: "7-11"},
            {name: "å…¨å®¶ å¥è¡Œåº—", lat: 24.1623, lng: 120.6789, type: "family"},
            {name: "OKä¾¿åˆ©å•†åº— ä¸­æ¸…åº—", lat: 24.1645, lng: 120.6712, type: "ok"},
            {name: "7-ELEVEN æ–°æ°‘åº—", lat: 24.1612, lng: 120.6823, type: "7-11"}
        ];

        // è‡ªå®šç¾©åœ–æ¨™
        const createIcon = (color, icon) => {
            return L.divIcon({
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="fas ${icon}" style="color: white; font-size: 10px;"></i></div>`,
                className: 'custom-marker',
                iconSize: [20, 20]
            });
        };

        // å‰µå»ºæ–‡å­—æ¨™ç±¤
        const createTextLabel = (text, options = {}) => {
            const defaultOptions = {
                color: '#2d3748',
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                fontSize: '12px',
                fontWeight: 'bold',
                padding: '4px 8px',
                borderRadius: '4px',
                border: '1px solid #e2e8f0',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                textAlign: 'center',
                minWidth: '60px',
                ...options
            };

            const styles = Object.entries(defaultOptions)
                .map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`)
                .join('; ');

            return L.divIcon({
                html: `<div style="${styles}">${text}</div>`,
                className: 'park-label',
                iconSize: [null, null],
                iconAnchor: [null, null]
            });
        };

        // æœå°‹åŠŸèƒ½å¯¦ç¾
        let searchResults = [];
        let currentSelectedIndex = -1;

        function performSearch(query) {
            if (!query || query.length < 1) {
                document.getElementById('searchSuggestions').style.display = 'none';
                return;
            }

            searchResults = parkData.filter(park => 
                park.name.toLowerCase().includes(query.toLowerCase())
            );

            const suggestionsEl = document.getElementById('searchSuggestions');
            
            if (searchResults.length === 0) {
                suggestionsEl.style.display = 'none';
                return;
            }

            const suggestionsHtml = searchResults.slice(0, 5).map((park, index) => `
                <div class="search-suggestion" data-index="${index}">
                    <strong>${park.name}</strong><br>
                    <small>é©å®œåº¦: ${park.suitability}/10 | ${park.description}</small>
                </div>
            `).join('');

            suggestionsEl.innerHTML = suggestionsHtml;
            suggestionsEl.style.display = 'block';

            // ç‚ºå»ºè­°é …ç›®æ·»åŠ é»æ“Šäº‹ä»¶
            suggestionsEl.querySelectorAll('.search-suggestion').forEach((item, index) => {
                item.addEventListener('click', () => {
                    selectPark(searchResults[index]);
                });
            });
        }

        function selectPark(park) {
            map.setView([park.lat, park.lng], 16);
            document.getElementById('searchBox').value = park.name;
            document.getElementById('searchSuggestions').style.display = 'none';
            
            // æ‰¾åˆ°å°æ‡‰çš„markerä¸¦æ‰“é–‹popup
            parkLayers.eachLayer(layer => {
                if (layer.getLatLng().lat === park.lat && layer.getLatLng().lng === park.lng) {
                    layer.openPopup();
                }
            });
        }

        // æœå°‹æ¡†äº‹ä»¶ç›£è½
        document.getElementById('searchBox').addEventListener('input', function(e) {
            performSearch(e.target.value);
        });

        // éµç›¤å°èˆª
        document.getElementById('searchBox').addEventListener('keydown', function(e) {
            const suggestions = document.querySelectorAll('.search-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSelectedIndex = Math.min(currentSelectedIndex + 1, suggestions.length - 1);
                updateSelectedSuggestion(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
                updateSelectedSuggestion(suggestions);
            } else if (e.key === 'Enter' && currentSelectedIndex >= 0) {
                e.preventDefault();
                selectPark(searchResults[currentSelectedIndex]);
            } else if (e.key === 'Escape') {
                document.getElementById('searchSuggestions').style.display = 'none';
                currentSelectedIndex = -1;
            }
        });

        function updateSelectedSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === currentSelectedIndex) {
                    item.style.backgroundColor = '#e3f2fd';
                } else {
                    item.style.backgroundColor = '';
                }
            });
        }

        // é»æ“Šå…¶ä»–åœ°æ–¹éš±è—å»ºè­°
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchSuggestions').style.display = 'none';
                currentSelectedIndex = -1;
            }
        });

        // æ¸²æŸ“å…¬åœ’
        function renderParks() {
            parkLayers.clearLayers();
            walkingRangeLayers.clearLayers();
            transportRangeLayers.clearLayers();
            lifeRangeLayers.clearLayers();
            safetyRangeLayers.clearLayers();
            parkLabelLayers.clearLayers();
            
            parkData.forEach(park => {
                let color = '#F44336'; // ä½é©å®œåº¦ - ç´…è‰²
                let show = false;
                
                if (park.suitability >= 8) {
                    color = '#4CAF50'; // é«˜é©å®œåº¦ - ç¶ è‰²
                    show = document.getElementById('highSuitability').checked;
                } else if (park.suitability >= 5) {
                    color = '#FF9800'; // ä¸­é©å®œåº¦ - æ©™è‰²
                    show = document.getElementById('mediumSuitability').checked;
                } else {
                    show = document.getElementById('lowSuitability').checked;
                }
                
                if (!show) return;
                
                // æª¢æŸ¥è¨­æ–½ç¯©é¸
                const facilityFilters = ['shelter', 'bench', 'water', 'toilet', 'lighting'];
                let facilityMatch = true;
                
                facilityFilters.forEach(facility => {
                    if (document.getElementById(facility).checked && !park.facilities.includes(facility)) {
                        facilityMatch = false;
                    }
                });
                
                if (!facilityMatch) return;
                
                // æª¢æŸ¥äº¤é€šä¾¿åˆ©æ€§
                if (!filterParksByTransport(park)) return;
                
                const marker = L.marker([park.lat, park.lng], {
                    icon: createIcon(color, 'fa-tree')
                });
                
                // è¨ˆç®—ç¶œåˆè©•åˆ†
                const compositeScore = calculateCompositeScore(park);
                const transportScore = calculateTransportScore(park);
                const facilityScore = calculateFacilityScore(park);
                
                // å‰µå»ºå½ˆå‡ºè¦–çª—å…§å®¹
                const facilitiesHtml = park.facilities.map(f => {
                    const icons = {
                        shelter: 'ğŸ ', bench: 'ğŸª‘', water: 'ğŸ’§', 
                        toilet: 'ğŸš»', lighting: 'ğŸ’¡'
                    };
                    const names = {
                        shelter: 'é®è”½è¨­æ–½', bench: 'åº§æ¤…', water: 'é£²æ°´å°',
                        toilet: 'å»æ‰€', lighting: 'ç…§æ˜'
                    };
                    return `${icons[f]} ${names[f]}`;
                }).join('<br>');
                
                // è¨ˆç®—æœ€è¿‘çš„æ·é‹ç«™å’Œå…¬è»Šç«™
                let nearestMRT = null;
                let nearestBus = null;
                let minMRTDistance = Infinity;
                let minBusDistance = Infinity;
                
                mrtData.forEach(station => {
                    const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                    if (distance < minMRTDistance) {
                        minMRTDistance = distance;
                        nearestMRT = station;
                    }
                });
                
                busData.forEach(busStop => {
                    const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                    if (distance < minBusDistance) {
                        minBusDistance = distance;
                        nearestBus = busStop;
                    }
                });
                
                const popupContent = `
                    <div class="popup-content">
                        <h4>${park.name} ${document.getElementById('enableScoring').checked ? `<span class="score-badge">${compositeScore}</span>` : ''}</h4>
                        <div class="rating">
                            é©å®œåº¦: ${'â­'.repeat(Math.floor(park.suitability / 2))} (${park.suitability}/10)
                        </div>
                        ${document.getElementById('enableScoring').checked ? `
                        <p><strong>ç¶œåˆè©•åˆ†:</strong> ${compositeScore}/10</p>
                        <p><strong>å„é …è©•åˆ†:</strong></p>
                        <p>ã€€ã€€äº¤é€š: ${transportScore}/10 | è¨­æ–½: ${facilityScore}/10</p>
                        <p>ã€€ã€€é©å®œ: ${park.suitability}/10 | å®‰å…¨: ${park.safety_score}/10</p>
                        ` : ''}
                        <p><strong>æè¿°:</strong> ${park.description}</p>
                        <p><strong>è¨­æ–½:</strong><br>${facilitiesHtml}</p>
                        <p><strong>å‘¨é‚Šæ”¶å…¥:</strong> ${park.income_level}</p>
                        ${nearestMRT ? `<p><strong>æœ€è¿‘æ·é‹:</strong> ${nearestMRT.name} (${Math.round(minMRTDistance)}m)</p>` : ''}
                        ${nearestBus ? `<p><strong>æœ€è¿‘å…¬è»Š:</strong> ${nearestBus.name} (${Math.round(minBusDistance)}m)</p>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                parkLayers.addLayer(marker);
                
                // ä»¥å…¬åœ’ç‚ºä¸­å¿ƒçš„åŠŸèƒ½åœ“åœˆ
                // 1. æ­¥è¡Œèˆ’é©ç¯„åœ (æœ€å…§åœˆ)
                if (document.getElementById('showWalkingRange').checked) {
                    const walkingRadius = document.getElementById('walkingRadius').value;
                    const walkingCircle = L.circle([park.lat, park.lng], {
                        color: '#4CAF50',
                        fillColor: '#4CAF50',
                        fillOpacity: 0.15,
                        weight: 2,
                        radius: walkingRadius,
                        dashArray: '5, 5'
                    });
                    
                    walkingCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - æ­¥è¡Œèˆ’é©ç¯„åœ</h4>
                            <p><strong>ç¯„åœ:</strong> ${walkingRadius}å…¬å°º</p>
                            <p><strong>èªªæ˜:</strong> é©åˆæ—¥å¸¸æ´»å‹•çš„æ­¥è¡Œè·é›¢</p>
                            <p><strong>æ¶µè“‹é¢ç©:</strong> ç´„${Math.round(Math.PI * Math.pow(walkingRadius/1000, 2) * 100) / 100}å¹³æ–¹å…¬é‡Œ</p>
                        </div>
                    `);
                    
                    walkingRangeLayers.addLayer(walkingCircle);
                }
                
                // 2. äº¤é€šå¯åŠç¯„åœ
                if (document.getElementById('showTransportRange').checked) {
                    const transportRadius = document.getElementById('transportRadius').value;
                    const transportCircle = L.circle([park.lat, park.lng], {
                        color: '#2196F3',
                        fillColor: '#2196F3',
                        fillOpacity: 0.08,
                        weight: 2,
                        radius: transportRadius,
                        dashArray: '10, 5'
                    });
                    
                    transportCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - äº¤é€šå¯åŠç¯„åœ</h4>
                            <p><strong>ç¯„åœ:</strong> ${transportRadius}å…¬å°º</p>
                            <p><strong>èªªæ˜:</strong> èƒ½åˆ°é”æ·é‹ç«™ã€å…¬è»Šç«™çš„ç¯„åœ</p>
                            <p><strong>æ¶µè“‹é¢ç©:</strong> ç´„${Math.round(Math.PI * Math.pow(transportRadius/1000, 2) * 100) / 100}å¹³æ–¹å…¬é‡Œ</p>
                        </div>
                    `);
                    
                    transportRangeLayers.addLayer(transportCircle);
                }
                
                // 3. ç”Ÿæ´»æ©Ÿèƒ½ç¯„åœ
                if (document.getElementById('showLifeRange').checked) {
                    const lifeRadius = document.getElementById('lifeRadius').value;
                    const lifeCircle = L.circle([park.lat, park.lng], {
                        color: '#FF9800',
                        fillColor: '#FF9800',
                        fillOpacity: 0.05,
                        weight: 2,
                        radius: lifeRadius,
                        dashArray: '15, 10'
                    });
                    
                    lifeCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - ç”Ÿæ´»æ©Ÿèƒ½ç¯„åœ</h4>
                            <p><strong>ç¯„åœ:</strong> ${lifeRadius}å…¬å°º</p>
                            <p><strong>èªªæ˜:</strong> ä¾¿åˆ©å•†åº—ã€é¤å»³ç­‰ç”Ÿæ´»è¨­æ–½çš„å¯åŠç¯„åœ</p>
                            <p><strong>æ¶µè“‹é¢ç©:</strong> ç´„${Math.round(Math.PI * Math.pow(lifeRadius/1000, 2) * 100) / 100}å¹³æ–¹å…¬é‡Œ</p>
                        </div>
                    `);
                    
                    lifeRangeLayers.addLayer(lifeCircle);
                }
                
                // 4. å®‰å…¨å½±éŸ¿ç¯„åœ
                if (document.getElementById('showSafetyRange').checked) {
                    const safetyRadius = document.getElementById('safetyRadius').value;
                    const safetyCircle = L.circle([park.lat, park.lng], {
                        color: '#9C27B0',
                        fillColor: '#9C27B0',
                        fillOpacity: 0.1,
                        weight: 2,
                        radius: safetyRadius,
                        dashArray: '20, 10'
                    });
                    
                    safetyCircle.bindPopup(`
                        <div class="popup-content">
                            <h4>${park.name} - å®‰å…¨å½±éŸ¿ç¯„åœ</h4>
                            <p><strong>ç¯„åœ:</strong> ${safetyRadius}å…¬å°º</p>
                            <p><strong>èªªæ˜:</strong> å…¬åœ’å®‰å…¨æ€§å½±éŸ¿çš„å‘¨é‚Šå€åŸŸ</p>
                            <p><strong>å®‰å…¨è©•åˆ†:</strong> ${park.safety_score}/10</p>
                            <p><strong>æ¶µè“‹é¢ç©:</strong> ç´„${Math.round(Math.PI * Math.pow(safetyRadius/1000, 2) * 100) / 100}å¹³æ–¹å…¬é‡Œ</p>
                        </div>
                    `);
                    
                    safetyRangeLayers.addLayer(safetyCircle);
                }
                
                // ç‚ºå…¬åœ’æ·»åŠ åç¨±æ¨™ç±¤ï¼ˆå¦‚æœå•Ÿç”¨äº†æ¨™ç±¤é¡¯ç¤ºï¼‰
                if (document.getElementById('showParkLabels').checked) {
                    let maxRadius = 0;
                    let labelColor = color;
                    
                    if (document.getElementById('showWalkingRange').checked) {
                        const radius = document.getElementById('walkingRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    if (document.getElementById('showTransportRange').checked) {
                        const radius = document.getElementById('transportRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    if (document.getElementById('showLifeRange').checked) {
                        const radius = document.getElementById('lifeRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    if (document.getElementById('showSafetyRange').checked) {
                        const radius = document.getElementById('safetyRadius').value;
                        if (radius > maxRadius) maxRadius = radius;
                    }
                    
                    // å¦‚æœæœ‰é¡¯ç¤ºä»»ä½•åœ“åœˆï¼Œå°±åœ¨åœ“åœˆä¸­å¿ƒé¡¯ç¤ºå…¬åœ’åç¨±
                    if (maxRadius > 0) {
                    // è¨ˆç®—æ¨™ç±¤é¡¯ç¤ºä½ç½®ï¼ˆåœ“åœˆä¸­å¿ƒé»ï¼‰
                    const labelOptions = {
                        color: labelColor,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        fontSize: '11px',
                        fontWeight: 'bold',
                        padding: '3px 6px',
                        borderRadius: '3px',
                        border: `2px solid ${labelColor}`,
                        boxShadow: '0 2px 6px rgba(0,0,0,0.2)',
                        textAlign: 'center',
                        minWidth: 'auto',
                        whiteSpace: 'nowrap'
                    };
                    
                    const labelMarker = L.marker([park.lat, park.lng], {
                        icon: createTextLabel(park.name, labelOptions),
                        zIndexOffset: 1000 // ç¢ºä¿æ¨™ç±¤é¡¯ç¤ºåœ¨æœ€ä¸Šå±¤
                    });
                    
                    // é»æ“Šæ¨™ç±¤ä¹Ÿèƒ½æ‰“é–‹å½ˆçª—
                    labelMarker.on('click', () => {
                        marker.openPopup();
                    });
                    
                        parkLabelLayers.addLayer(labelMarker);
                    } else {
                        // å¦‚æœæ²’æœ‰é¡¯ç¤ºåœ“åœˆï¼Œå°±åœ¨å…¬åœ’åœ–æ¨™æ—é¡¯ç¤ºåç¨±
                        const labelOptions = {
                            color: '#2d3748',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            fontSize: '10px',
                            fontWeight: 'bold',
                            padding: '2px 4px',
                            borderRadius: '2px',
                            border: '1px solid #e2e8f0',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                            textAlign: 'center',
                            minWidth: 'auto',
                            whiteSpace: 'nowrap'
                        };
                        
                        // åœ¨å…¬åœ’åœ–æ¨™å³å´é¡¯ç¤ºåç¨±
                        const labelMarker = L.marker([park.lat, park.lng + 0.001], {
                            icon: createTextLabel(park.name, labelOptions),
                            zIndexOffset: 1000
                        });
                        
                        labelMarker.on('click', () => {
                            marker.openPopup();
                        });
                        
                        parkLabelLayers.addLayer(labelMarker);
                    }
                }
            });
        }

        // æ¸²æŸ“æ”¶å…¥å€åŸŸ
        function renderIncomeAreas() {
            incomeCircleLayers.clearLayers();
            incomeClusterGroup.clearLayers();
            
            if (!document.getElementById('showIncomeLayer').checked) return;
            
            const maxIncome = document.getElementById('incomeRange').value;
            const onlySelected = document.getElementById('onlySelectedIncome').checked;
            const showCluster = document.getElementById('showIncomeCluster').checked;
            const circleRadius = document.getElementById('incomeCircleRadius').value;
            
            incomeAreas.forEach(area => {
                if (onlySelected && area.income > maxIncome) return;
                
                let color = '#F44336'; // ä½æ”¶å…¥ - ç´…è‰²
                let opacity = 0.4;
                
                if (area.income >= 60) {
                    color = '#4CAF50'; // é«˜æ”¶å…¥ - ç¶ è‰²
                } else if (area.income >= 45) {
                    color = '#FF9800'; // ä¸­é«˜æ”¶å…¥ - æ©™è‰²
                } else if (area.income >= 35) {
                    color = '#2196F3'; // ä¸­ç­‰æ”¶å…¥ - è—è‰²
                } else {
                    color = '#9C27B0'; // ä¸­ä½æ”¶å…¥ - ç´«è‰²
                }
                
                // å¦‚æœè¶…éè¨­å®šæ”¶å…¥ï¼Œé™ä½é€æ˜åº¦
                if (area.income > maxIncome) {
                    opacity = 0.15;
                }
                
                // è¨ˆç®—æ”¶å…¥å€åŸŸä¸­å¿ƒé»
                const centerLat = (area.bounds[0][0] + area.bounds[1][0]) / 2;
                const centerLng = (area.bounds[0][1] + area.bounds[1][1]) / 2;
                
                // å‰µå»ºåœ“åœˆä»£æ›¿å¤šé‚Šå½¢
                const circle = L.circle([centerLat, centerLng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: opacity,
                    weight: 2,
                    radius: circleRadius,
                    dashArray: '8, 12'
                });
                
                circle.bindPopup(`
                    <div class="popup-content">
                        <h4>${area.name} - æ”¶å…¥å½±éŸ¿åœˆ</h4>
                        <p><strong>å¹³å‡æœˆæ”¶å…¥:</strong> ${area.income}è¬å…ƒ</p>
                        <p><strong>æ”¶å…¥ç­‰ç´š:</strong> ${area.level}</p>
                        <p><strong>å½±éŸ¿ç¯„åœ:</strong> ${circleRadius}å…¬å°º</p>
                        <p><strong>æ¶µè“‹é¢ç©:</strong> ç´„${Math.round(Math.PI * Math.pow(circleRadius/1000, 2) * 100) / 100}å¹³æ–¹å…¬é‡Œ</p>
                        <p><strong>èªªæ˜:</strong> æ­¤æ”¶å…¥æ°´å¹³å°å‘¨é‚Šç’°å¢ƒçš„å½±éŸ¿ç¯„åœ</p>
                    </div>
                `);
                
                incomeCircleLayers.addLayer(circle);
                
                // å¦‚æœå•Ÿç”¨å¢é›†ï¼Œå‰µå»ºæ”¶å…¥å€åŸŸä¸­å¿ƒé»æ¨™è¨˜
                if (showCluster) {
                    const marker = L.marker([centerLat, centerLng], {
                        icon: createIcon(color, 'fa-dollar-sign'),
                        income: area.income
                    });
                    
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h4>${area.name}</h4>
                            <p><strong>å¹³å‡æœˆæ”¶å…¥:</strong> ${area.income}è¬å…ƒ</p>
                            <p><strong>æ”¶å…¥ç­‰ç´š:</strong> ${area.level}</p>
                            <p><strong>å½±éŸ¿åŠå¾‘:</strong> ${circleRadius}å…¬å°º</p>
                        </div>
                    `);
                    
                    incomeClusterGroup.addLayer(marker);
                }
            });
        }

        // æ¸²æŸ“æ·é‹ç«™
        function renderMRT() {
            if (!document.getElementById('showMRT').checked) return;
            
            mrtData.forEach(station => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: createIcon('#2196F3', 'fa-subway')
                });
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${station.name}</h4>
                        <p><strong>è·¯ç·š:</strong> ${station.line}</p>
                        <p>ğŸš‡ æ·é‹ç«™</p>
                    </div>
                `);
                
                transportLayers.addLayer(marker);
            });
        }

        // æ¸²æŸ“å…¬è»Šç«™
        function renderBusStops() {
            if (!document.getElementById('showBus').checked) return;
            
            busData.forEach(busStop => {
                const marker = L.marker([busStop.lat, busStop.lng], {
                    icon: createIcon('#FF5722', 'fa-bus')
                });
                
                const routesHtml = busStop.routes.slice(0, 10).join(', ') + 
                    (busStop.routes.length > 10 ? '...' : '');
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${busStop.name}</h4>
                        <p><strong>è·¯ç·š:</strong> ${routesHtml}</p>
                        <p>ğŸšŒ å…¬è»Šç«™ (${busStop.routes.length}æ¢è·¯ç·š)</p>
                    </div>
                `);
                
                transportLayers.addLayer(marker);
            });
        }

        // æ¸²æŸ“ä¾¿åˆ©å•†åº—
        function renderConvenience() {
            if (!document.getElementById('convenience').checked) return;
            
            convenienceData.forEach(store => {
                const color = store.type === '7-11' ? '#00A651' : '#0066CC';
                const marker = L.marker([store.lat, store.lng], {
                    icon: createIcon(color, 'fa-store')
                });
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h4>${store.name}</h4>
                        <p>ğŸª ${store.type === '7-11' ? '7-ELEVEN' : 'å…¨å®¶ä¾¿åˆ©å•†åº—'}</p>
                        <p>24å°æ™‚ç‡Ÿæ¥­</p>
                    </div>
                `);
                
                facilityLayers.addLayer(marker);
            });
        }

        // ç¯©é¸ç¬¦åˆäº¤é€šæ¢ä»¶çš„å…¬åœ’
        function filterParksByTransport(park) {
            const mrtRange = document.getElementById('mrtDistance').value;
            const busRange = document.getElementById('busDistance').value;
            
            let nearMRT = false;
            let nearBus = false;
            
            // æª¢æŸ¥æ·é‹ç«™è·é›¢
            if (document.getElementById('showMRT').checked) {
                mrtData.forEach(station => {
                    const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                    if (distance <= mrtRange) nearMRT = true;
                });
            } else {
                nearMRT = true; // å¦‚æœä¸é¡¯ç¤ºæ·é‹ç«™ï¼Œå‰‡ä¸é™åˆ¶
            }
            
            // æª¢æŸ¥å…¬è»Šç«™è·é›¢  
            if (document.getElementById('showBus').checked) {
                busData.forEach(busStop => {
                    const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                    if (distance <= busRange) nearBus = true;
                });
            } else {
                nearBus = true; // å¦‚æœä¸é¡¯ç¤ºå…¬è»Šç«™ï¼Œå‰‡ä¸é™åˆ¶
            }
            
            return nearMRT || nearBus;
        }

        // è¨ˆç®—å…©é»è·é›¢ (å…¬å°º)
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // åœ°çƒåŠå¾‘ (å…¬å°º)
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // è¨ˆç®—å…¬åœ’çš„äº¤é€šä¾¿åˆ©æ€§è©•åˆ† (0-10)
        function calculateTransportScore(park) {
            let score = 0;
            let nearestMRTDistance = Infinity;
            let nearestBusDistance = Infinity;
            let busRouteCount = 0;

            // è¨ˆç®—æœ€è¿‘æ·é‹ç«™è·é›¢
            mrtData.forEach(station => {
                const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                if (distance < nearestMRTDistance) {
                    nearestMRTDistance = distance;
                }
            });

            // è¨ˆç®—æœ€è¿‘å…¬è»Šç«™è·é›¢å’Œè·¯ç·šæ•¸é‡
            busData.forEach(busStop => {
                const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                if (distance < nearestBusDistance) {
                    nearestBusDistance = distance;
                }
                if (distance <= 500) { // 500å…¬å°ºå…§çš„å…¬è»Šç«™
                    busRouteCount += busStop.routes.length;
                }
            });

            // æ·é‹è·é›¢è©•åˆ† (0-4åˆ†)
            if (nearestMRTDistance <= 300) score += 4;
            else if (nearestMRTDistance <= 500) score += 3;
            else if (nearestMRTDistance <= 800) score += 2;
            else if (nearestMRTDistance <= 1200) score += 1;

            // å…¬è»Šè·é›¢è©•åˆ† (0-3åˆ†)
            if (nearestBusDistance <= 200) score += 3;
            else if (nearestBusDistance <= 400) score += 2;
            else if (nearestBusDistance <= 600) score += 1;

            // å…¬è»Šè·¯ç·šæ•¸é‡è©•åˆ† (0-3åˆ†)
            if (busRouteCount >= 20) score += 3;
            else if (busRouteCount >= 10) score += 2;
            else if (busRouteCount >= 5) score += 1;

            return Math.min(score, 10);
        }

        // è¨ˆç®—è¨­æ–½å®Œå–„åº¦è©•åˆ† (0-10)
        function calculateFacilityScore(park) {
            const facilityWeights = {
                shelter: 2.5,   // é®è”½è¨­æ–½
                toilet: 2.5,    // å»æ‰€
                water: 2,       // é£²æ°´è¨­æ–½
                lighting: 2,    // ç…§æ˜
                bench: 1        // åº§æ¤…
            };

            let score = 0;
            park.facilities.forEach(facility => {
                if (facilityWeights[facility]) {
                    score += facilityWeights[facility];
                }
            });

            return Math.min(score, 10);
        }

        // è¨ˆç®—ç¶œåˆè©•åˆ†
        function calculateCompositeScore(park) {
            if (!document.getElementById('enableScoring').checked) return park.suitability;

            const transportWeight = document.getElementById('transportWeight').value / 100;
            const facilityWeight = document.getElementById('facilityWeight').value / 100;
            const suitabilityWeight = document.getElementById('suitabilityWeight').value / 100;
            const safetyWeight = document.getElementById('safetyWeight').value / 100;

            const transportScore = calculateTransportScore(park);
            const facilityScore = calculateFacilityScore(park);
            const suitabilityScore = park.suitability;
            const safetyScore = park.safety_score;

            const compositeScore = (
                transportScore * transportWeight +
                facilityScore * facilityWeight +
                suitabilityScore * suitabilityWeight +
                safetyScore * safetyWeight
            );

            return Math.round(compositeScore * 10) / 10; // å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œä¸€ä½
        }

        // è¨ˆç®—å…¬åœ’å‘¨é‚Šçš„æ”¶å…¥å€åŸŸ
        function getParkIncomeInfo(park) {
            let nearbyIncomeAreas = [];
            
            incomeAreas.forEach(area => {
                const centerLat = (area.bounds[0][0] + area.bounds[1][0]) / 2;
                const centerLng = (area.bounds[0][1] + area.bounds[1][1]) / 2;
                const distance = getDistance(park.lat, park.lng, centerLat, centerLng);
                
                if (distance <= 1000) { // 1å…¬é‡Œå…§
                    nearbyIncomeAreas.push({...area, distance});
                }
            });
            
            nearbyIncomeAreas.sort((a, b) => a.distance - b.distance);
            return nearbyIncomeAreas[0] || {name: "æœªçŸ¥å€åŸŸ", income: 0, level: "ç„¡è³‡æ–™"};
        }

        // è¨ˆç®—å…¬åœ’å‘¨é‚Šçš„äº¤é€šè³‡è¨Š
        function getParkTransportInfo(park) {
            let nearbyMRT = [];
            let nearbyBus = [];
            
            mrtData.forEach(station => {
                const distance = getDistance(park.lat, park.lng, station.lat, station.lng);
                if (distance <= 1000) {
                    nearbyMRT.push({...station, distance});
                }
            });
            
            busData.forEach(busStop => {
                const distance = getDistance(park.lat, park.lng, busStop.lat, busStop.lng);
                if (distance <= 800) {
                    nearbyBus.push({...busStop, distance});
                }
            });
            
            nearbyMRT.sort((a, b) => a.distance - b.distance);
            nearbyBus.sort((a, b) => a.distance - b.distance);
            
            return {
                mrtCount: nearbyMRT.length,
                busCount: nearbyBus.length,
                nearestMRT: nearbyMRT[0] || null,
                nearestBus: nearbyBus[0] || null,
                totalBusRoutes: nearbyBus.reduce((sum, bus) => sum + bus.routes.length, 0)
            };
        }

        // æ›´æ–°å…¬åœ’è©³ç´°åˆ—è¡¨
        function updateParkDetailList() {
            if (!document.getElementById('showParkList').checked) {
                document.getElementById('parkListSection').style.display = 'none';
                return;
            }
            
            document.getElementById('parkListSection').style.display = 'block';
            
            // ç²å–ç¬¦åˆç¯©é¸æ¢ä»¶çš„å…¬åœ’
            let filteredParks = parkData.filter(park => {
                // é©å®œåº¦ç¯©é¸
                let suitabilityMatch = false;
                if (park.suitability >= 8 && document.getElementById('highSuitability').checked) suitabilityMatch = true;
                if (park.suitability >= 5 && park.suitability < 8 && document.getElementById('mediumSuitability').checked) suitabilityMatch = true;
                if (park.suitability < 5 && document.getElementById('lowSuitability').checked) suitabilityMatch = true;
                
                if (!suitabilityMatch) return false;
                
                // è¨­æ–½ç¯©é¸
                const facilityFilters = ['shelter', 'bench', 'water', 'toilet', 'lighting'];
                let facilityMatch = true;
                facilityFilters.forEach(facility => {
                    if (document.getElementById(facility).checked && !park.facilities.includes(facility)) {
                        facilityMatch = false;
                    }
                });
                
                if (!facilityMatch) return false;
                
                // äº¤é€šä¾¿åˆ©æ€§ç¯©é¸
                return filterParksByTransport(park);
            });
            
            // å¦‚æœåªé¡¯ç¤ºå¯è¦‹å…¬åœ’ï¼Œé€²ä¸€æ­¥ç¯©é¸
            if (document.getElementById('showOnlyVisible').checked) {
                // é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„å¯è¦‹æ€§é‚è¼¯
            }
            
            // æŒ‰ç¶œåˆè©•åˆ†æ’åº
            filteredParks = filteredParks.map(park => ({
                ...park,
                compositeScore: calculateCompositeScore(park),
                transportScore: calculateTransportScore(park),
                facilityScore: calculateFacilityScore(park),
                incomeInfo: getParkIncomeInfo(park),
                transportInfo: getParkTransportInfo(park)
            })).sort((a, b) => b.compositeScore - a.compositeScore);
            
            // ç”ŸæˆHTML
            const parkListHtml = filteredParks.map(park => `
                <div class="park-item" onclick="selectParkFromList('${park.name}', ${park.lat}, ${park.lng})">
                    <div class="park-name">
                        ${park.name}
                        <span class="park-score">${park.compositeScore}</span>
                    </div>
                    <div class="park-info">
                        ${park.description}
                    </div>
                    <div class="park-stats">
                        <div class="stat-item">
                            <div class="stat-label">æ”¶å…¥å€åŸŸ</div>
                            <div class="stat-value">${park.incomeInfo.name}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æ”¶å…¥æ°´å¹³</div>
                            <div class="stat-value">${park.incomeInfo.income}è¬</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æ·é‹ç«™</div>
                            <div class="stat-value">${park.transportInfo.mrtCount}å€‹</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å…¬è»Šç«™</div>
                            <div class="stat-value">${park.transportInfo.busCount}å€‹</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å…¬è»Šè·¯ç·š</div>
                            <div class="stat-value">${park.transportInfo.totalBusRoutes}æ¢</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">è¨­æ–½å®Œå–„åº¦</div>
                            <div class="stat-value">${park.facilityScore}/10</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('parkDetailList').innerHTML = parkListHtml;
        }

        // å¾åˆ—è¡¨ä¸­é¸æ“‡å…¬åœ’
        function selectParkFromList(parkName, lat, lng) {
            map.setView([lat, lng], 16);
            
            parkLayers.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                    layer.openPopup();
                }
            });
        }

        // æ›´æ–°è©•åˆ†æ’åé¡¯ç¤º
        function updateScoreRanking() {
            const showRanking = document.getElementById('showScoreRanking').checked;
            const rankingSection = document.getElementById('scoreRankingSection');
            
            if (!showRanking) {
                rankingSection.style.display = 'none';
                return;
            }
            
            rankingSection.style.display = 'block';
            
            // è¨ˆç®—æ‰€æœ‰å…¬åœ’çš„è©•åˆ†ä¸¦æ’åº
            const rankedParks = parkData.map(park => ({
                ...park,
                compositeScore: calculateCompositeScore(park),
                transportScore: calculateTransportScore(park),
                facilityScore: calculateFacilityScore(park)
            })).sort((a, b) => b.compositeScore - a.compositeScore);
            
            // åªé¡¯ç¤ºå‰10å
            const top10Parks = rankedParks.slice(0, 10);
            
            const rankingHtml = top10Parks.map((park, index) => `
                <div class="ranking-item" onclick="selectParkFromRanking('${park.name}', ${park.lat}, ${park.lng})">
                    <span class="ranking-number">${index + 1}</span>
                    <strong>${park.name}</strong>
                    <span class="ranking-score">${park.compositeScore}</span>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
                        äº¤é€š:${park.transportScore} | è¨­æ–½:${park.facilityScore} | é©å®œ:${park.suitability} | å®‰å…¨:${park.safety_score}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('scoreRankingList').innerHTML = rankingHtml;
        }

        // å¾æ’åä¸­é¸æ“‡å…¬åœ’
        function selectParkFromRanking(parkName, lat, lng) {
            map.setView([lat, lng], 16);
            
            // æ‰¾åˆ°å°æ‡‰çš„markerä¸¦æ‰“é–‹popup
            parkLayers.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                    layer.openPopup();
                }
            });
        }

        // æ›´æ–°åœ°åœ–
        function updateMap() {
            // æ¸…é™¤æ‰€æœ‰åœ–å±¤
            transportLayers.clearLayers();
            facilityLayers.clearLayers();
            
            // é‡æ–°æ¸²æŸ“
            renderParks();
            renderMRT();
            renderBusStops();
            renderConvenience();
            renderIncomeAreas();
            
            // æ›´æ–°å…¬åœ’åˆ—è¡¨
            updateParkDetailList();
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('highSuitability').checked = true;
            document.getElementById('mediumSuitability').checked = true;
            document.getElementById('lowSuitability').checked = false;
            
            ['shelter', 'bench', 'water', 'toilet', 'lighting'].forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            document.getElementById('showMRT').checked = true;
            document.getElementById('showBus').checked = true;
            document.getElementById('showBike').checked = false;
            document.getElementById('showIncomeLayer').checked = true;
            document.getElementById('showIncomeCluster').checked = true;
            document.getElementById('onlySelectedIncome').checked = false;
            document.getElementById('convenience').checked = true;
            document.getElementById('pharmacy').checked = false;
            document.getElementById('restaurant').checked = false;
            document.getElementById('showWalkingRange').checked = true;
            document.getElementById('showTransportRange').checked = true;
            document.getElementById('showLifeRange').checked = false;
            document.getElementById('showSafetyRange').checked = false;
            document.getElementById('showParkLabels').checked = true;
            document.getElementById('enableScoring').checked = true;
            document.getElementById('showParkList').checked = true;
            document.getElementById('showOnlyVisible').checked = false;
            
            document.getElementById('mrtDistance').value = 1000;
            document.getElementById('busDistance').value = 500;
            document.getElementById('incomeRange').value = 60;
            document.getElementById('walkingRadius').value = 200;
            document.getElementById('transportRadius').value = 600;
            document.getElementById('lifeRadius').value = 800;
            document.getElementById('safetyRadius').value = 400;
            document.getElementById('incomeCircleRadius').value = 700;
            document.getElementById('transportWeight').value = 35;
            document.getElementById('facilityWeight').value = 25;
            document.getElementById('suitabilityWeight').value = 30;
            document.getElementById('safetyWeight').value = 10;
            
            document.getElementById('mrtValue').textContent = '1000å…¬å°ºå…§';
            document.getElementById('busValue').textContent = '500å…¬å°ºå…§';
            document.getElementById('incomeValue').textContent = '60è¬ä»¥ä¸‹å€åŸŸ';
            document.getElementById('walkingRadiusValue').textContent = '200å…¬å°º';
            document.getElementById('transportRadiusValue').textContent = '600å…¬å°º';
            document.getElementById('lifeRadiusValue').textContent = '800å…¬å°º';
            document.getElementById('safetyRadiusValue').textContent = '400å…¬å°º';
            document.getElementById('incomeCircleRadiusValue').textContent = '700å…¬å°º';
            document.getElementById('transportWeightValue').textContent = '35%';
            document.getElementById('facilityWeightValue').textContent = '25%';
            document.getElementById('suitabilityWeightValue').textContent = '30%';
            document.getElementById('safetyWeightValue').textContent = '10%';
            
            updateMap();
        }

        // è·é›¢æ»‘æ¡¿æ›´æ–°
        document.getElementById('mrtDistance').addEventListener('input', function(e) {
            document.getElementById('mrtValue').textContent = e.target.value + 'å…¬å°ºå…§';
            updateMap();
        });

        document.getElementById('busDistance').addEventListener('input', function(e) {
            document.getElementById('busValue').textContent = e.target.value + 'å…¬å°ºå…§';
            updateMap();
        });

        document.getElementById('incomeRange').addEventListener('input', function(e) {
            document.getElementById('incomeValue').textContent = e.target.value + 'è¬ä»¥ä¸‹å€åŸŸ';
            updateMap();
        });

        // åŠŸèƒ½åœ“åœˆåŠå¾‘æ»‘æ¡¿äº‹ä»¶ç›£è½å™¨
        document.getElementById('walkingRadius').addEventListener('input', function(e) {
            document.getElementById('walkingRadiusValue').textContent = e.target.value + 'å…¬å°º';
            updateMap();
        });

        document.getElementById('transportRadius').addEventListener('input', function(e) {
            document.getElementById('transportRadiusValue').textContent = e.target.value + 'å…¬å°º';
            updateMap();
        });

        document.getElementById('lifeRadius').addEventListener('input', function(e) {
            document.getElementById('lifeRadiusValue').textContent = e.target.value + 'å…¬å°º';
            updateMap();
        });

        document.getElementById('safetyRadius').addEventListener('input', function(e) {
            document.getElementById('safetyRadiusValue').textContent = e.target.value + 'å…¬å°º';
            updateMap();
        });

        // æ”¶å…¥å€åŸŸåœ“åœˆåŠå¾‘æ»‘æ¡¿äº‹ä»¶ç›£è½å™¨
        document.getElementById('incomeCircleRadius').addEventListener('input', function(e) {
            document.getElementById('incomeCircleRadiusValue').textContent = e.target.value + 'å…¬å°º';
            updateMap();
        });

        // è©•åˆ†æ¬Šé‡æ»‘æ¡¿äº‹ä»¶ç›£è½å™¨
        document.getElementById('transportWeight').addEventListener('input', function(e) {
            document.getElementById('transportWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        document.getElementById('facilityWeight').addEventListener('input', function(e) {
            document.getElementById('facilityWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        document.getElementById('suitabilityWeight').addEventListener('input', function(e) {
            document.getElementById('suitabilityWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        document.getElementById('safetyWeight').addEventListener('input', function(e) {
            document.getElementById('safetyWeightValue').textContent = e.target.value + '%';
            updateMap();
        });

        // å…¬åœ’åˆ—è¡¨é¡¯ç¤ºåˆ‡æ›
        document.getElementById('showParkList').addEventListener('change', function(e) {
            updateParkDetailList();
        });

        document.getElementById('showOnlyVisible').addEventListener('change', function(e) {
            updateParkDetailList();
        });

        // ç¯©é¸æ¢ä»¶è®ŠåŒ–æ™‚æ›´æ–°åœ°åœ–
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateMap);
        });

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateMap);
        });

        // åˆå§‹åŒ–åœ°åœ–
        updateMap();

    </script>
</body>
</html>
